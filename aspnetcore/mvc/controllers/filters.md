---
title: Filtres
author: ardalis
description: "Découvrez comment * filtres * travail et comment les utiliser dans ASP.NET MVC de base."
keywords: "ASP.NET Core, filtres, filtres mvc, filtres d’action, les filtres d’autorisation, les filtres de ressource, filtres de résultat, les filtres d’exception"
ms.author: tdykstra
manager: wpickett
ms.date: 12/12/2016
ms.topic: article
ms.assetid: 531bda08-aa5b-4471-8f08-96add22c8683
ms.technology: aspnet
ms.prod: asp.net-core
uid: mvc/controllers/filters
ms.openlocfilehash: 6baeb472770daf1d54b2d9ea894fc710f4f40780
ms.sourcegitcommit: 4693cb02d845adf2efa00e07ad432c81867bfa12
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/08/2017
---
# <a name="filters"></a><span data-ttu-id="5f0b7-104">Filtres</span><span class="sxs-lookup"><span data-stu-id="5f0b7-104">Filters</span></span>

<span data-ttu-id="5f0b7-105">Par [Tom Dykstra](https://github.com/tdykstra/) et [Steve Smith](http://ardalis.com)</span><span class="sxs-lookup"><span data-stu-id="5f0b7-105">By [Tom Dykstra](https://github.com/tdykstra/) and [Steve Smith](http://ardalis.com)</span></span>

<span data-ttu-id="5f0b7-106">*Filtres* dans ASP.NET MVC de base vous autorise à exécuter du code avant ou après certaines étapes du pipeline de traitement de la demande.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-106">*Filters* in ASP.NET Core MVC allow you to run code before or after certain stages in the request processing pipeline.</span></span>

 <span data-ttu-id="5f0b7-107">Les filtres intégrés handle des tâches telles que l’autorisation (empêche l’accès aux ressources de pour qu'un utilisateur n’est pas autorisé), de vous assurer que toutes les demandes utiliser HTTPS et réponse (le pipeline de requête pour retourner une réponse mise en cache de court-circuit) de la mise en cache.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-107">Built-in filters handle tasks such as authorization (preventing access to resources a user isn't authorized for), ensuring that all requests use HTTPS, and response caching (short-circuiting the request pipeline to return a cached response).</span></span> 

<span data-ttu-id="5f0b7-108">Vous pouvez créer des filtres personnalisés pour gérer les problèmes transversaux pour votre application.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-108">You can create custom filters to handle cross-cutting concerns for your application.</span></span> <span data-ttu-id="5f0b7-109">Chaque fois que vous souhaitez éviter la duplication de code entre les actions, les filtres sont la solution.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-109">Anytime you want to avoid duplicating code across actions, filters are the solution.</span></span> <span data-ttu-id="5f0b7-110">Par exemple, vous pouvez consolider les code dans un filtre d’exception de la gestion des erreurs.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-110">For example, you can consolidate error handling code in a exception filter.</span></span>

<span data-ttu-id="5f0b7-111">[Afficher ou télécharger l’exemple à partir de GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-111">[View or download sample from GitHub](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span></span>

## <a name="how-do-filters-work"></a><span data-ttu-id="5f0b7-112">Fonctionnement des filtres</span><span class="sxs-lookup"><span data-stu-id="5f0b7-112">How do filters work?</span></span>

<span data-ttu-id="5f0b7-113">Filtres sont exécutés dans le *pipeline d’invocation d’action MVC*, parfois appelé le *pipeline des filtres*.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-113">Filters run within the *MVC action invocation pipeline*, sometimes referred to as the *filter pipeline*.</span></span>  <span data-ttu-id="5f0b7-114">Le pipeline de filtre s’exécute après que MVC sélectionne l’action à exécuter.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-114">The filter pipeline runs after MVC selects the action to execute.</span></span>

![La demande est traitée via un autre intergiciel (middleware), routage intergiciel (middleware), la sélection de l’Action et le Pipeline de Invocation d’Action MVC.](filters/_static/filter-pipeline-1.png)

### <a name="filter-types"></a><span data-ttu-id="5f0b7-117">Types de filtres</span><span class="sxs-lookup"><span data-stu-id="5f0b7-117">Filter types</span></span>

<span data-ttu-id="5f0b7-118">Chaque type de filtre est exécutée sur une autre étape du pipeline de filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-118">Each filter type is executed at a different stage in the filter pipeline.</span></span>

* <span data-ttu-id="5f0b7-119">[Filtres d’autorisation](#authorization-filters) exécutés en premier et sont utilisées pour déterminer si l’utilisateur actuel est autorisé pour la requête actuelle.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-119">[Authorization filters](#authorization-filters) run first and are used to determine whether the current user is authorized for the current request.</span></span> <span data-ttu-id="5f0b7-120">Ils peuvent court-circuit le pipeline si une demande n’est pas autorisée.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-120">They can short-circuit the pipeline if a request is unauthorized.</span></span> 

* <span data-ttu-id="5f0b7-121">[Filtres de ressources](#resource-filters) sont les premières à traiter une demande après l’autorisation.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-121">[Resource filters](#resource-filters) are the first to handle a request after authorization.</span></span>  <span data-ttu-id="5f0b7-122">Ils peuvent exécuter le code avant le reste du pipeline de filtre et une fois que le reste du pipeline est terminé.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-122">They can run code before the rest of the filter pipeline, and after the rest of the pipeline has completed.</span></span> <span data-ttu-id="5f0b7-123">Ils ne sont utiles pour implémenter la mise en cache ou de court-circuit sinon le pipeline de filtre pour des raisons de performances.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-123">They're useful to implement caching or otherwise short-circuit the filter pipeline for performance reasons.</span></span> <span data-ttu-id="5f0b7-124">Dans la mesure où ils s’exécuter avant la liaison de modèle, ils ne sont pas utiles pour tout élément qui a besoin pour influencer la liaison de modèle.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-124">Since they run before model binding, they're useful for anything that needs to influence model binding.</span></span>

* <span data-ttu-id="5f0b7-125">[Filtres d’action](#action-filters) peut exécuter du code juste avant et après l’appel d’une méthode d’action individuelle.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-125">[Action filters](#action-filters) can run code immediately before and after an individual action method is called.</span></span> <span data-ttu-id="5f0b7-126">Ils peuvent être utilisés pour manipuler les arguments transmis à une action et le résultat retourné à partir de l’action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-126">They can be used to manipulate the arguments passed into an action and the result returned from the action.</span></span>

* <span data-ttu-id="5f0b7-127">[Filtres d’exception](#exception-filters) sont utilisées pour appliquer des stratégies globales pour les exceptions non gérées qui se produisent avant tout élément a été écrit dans le corps de réponse.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-127">[Exception filters](#exception-filters) are used to apply global policies to unhandled exceptions that occur before anything has been written to the response body.</span></span>

* <span data-ttu-id="5f0b7-128">[Filtres de résultat](#result-filters) peut exécuter du code juste avant et après l’exécution de résultats d’action individuelles.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-128">[Result filters](#result-filters) can run code immediately before and after the execution of individual action results.</span></span> <span data-ttu-id="5f0b7-129">Ils s’exécutent uniquement lorsque la méthode d’action a été exécutée correctement et sont utiles pour la logique qui doit entourer l’affichage ou le module de formatage de l’exécution.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-129">They run only when the action method has executed successfully and are useful for logic that must surround view or formatter execution.</span></span>

<span data-ttu-id="5f0b7-130">Le diagramme suivant illustre l’interagissent entre ces types de filtres dans le pipeline de filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-130">The following diagram shows how these filter types interact in the filter pipeline.</span></span>

![La demande est traitée par le biais d’autorisation filtres, ressources, liaison de modèle, filtres d’Action, l’exécution d’Action et Conversion de résultat d’Action, les filtres d’Exception, filtres de résultat et l’exécution du résultat.](filters/_static/filter-pipeline-2.png)

## <a name="implementation"></a><span data-ttu-id="5f0b7-133">Implémentation</span><span class="sxs-lookup"><span data-stu-id="5f0b7-133">Implementation</span></span>

<span data-ttu-id="5f0b7-134">Filtres prennent en charge les implémentations synchrones et asynchrones via des définitions d’interface différente.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-134">Filters support both synchronous and asynchronous implementations through different interface definitions.</span></span> <span data-ttu-id="5f0b7-135">Choisissez la synchronisation ou async variant en fonction du type de tâche, que vous devez effectuer.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-135">Choose either the sync or async variant depending on the kind of task you need to perform.</span></span> 

<span data-ttu-id="5f0b7-136">Synchrones filtres qui peuvent s’exécuter à la fois du code avant et après leur phase de pipeline est défini sur*étape*en cours d’exécution et*étape*exécutée de méthodes.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-136">Synchronous filters that can run code both before and after their pipeline stage define On*Stage*Executing and On*Stage*Executed methods.</span></span> <span data-ttu-id="5f0b7-137">Par exemple, `OnActionExecuting` est appelé avant d’appeler la méthode d’action, et `OnActionExecuted` est appelée après le retour de la méthode d’action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-137">For example, `OnActionExecuting` is called before the action method is called, and `OnActionExecuted` is called after the action method returns.</span></span>

<span data-ttu-id="5f0b7-138">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?highlight=6,8,13)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-138">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?highlight=6,8,13)]</span></span>

<span data-ttu-id="5f0b7-139">Les filtres asynchrones définissent un seul sur*étape*ExecutionAsync méthode.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-139">Asynchronous filters define a single On*Stage*ExecutionAsync method.</span></span> <span data-ttu-id="5f0b7-140">Cette méthode prend un *FilterType*délégué ExecutionDelegate qui exécute l’étape de pipeline du filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-140">This method takes a *FilterType*ExecutionDelegate delegate which executes the filter's pipeline stage.</span></span> <span data-ttu-id="5f0b7-141">Par exemple, `ActionExecutionDelegate` appelle la méthode d’action et vous pouvez exécuter du code avant et après l’appel à elle.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-141">For example, `ActionExecutionDelegate` calls the action method, and you can execute code before and after you call it.</span></span>

<span data-ttu-id="5f0b7-142">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleAsyncActionFilter.cs?highlight=6,8-10,13)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-142">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleAsyncActionFilter.cs?highlight=6,8-10,13)]</span></span>

<span data-ttu-id="5f0b7-143">Vous pouvez implémenter des interfaces pour plusieurs étapes de filtre dans une classe unique.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-143">You can implement interfaces for multiple filter stages in a single class.</span></span> <span data-ttu-id="5f0b7-144">Par exemple, le [ActionFilterAttribute](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionfilterattribute) classe abstraite implémente à la fois `IActionFilter` et `IResultFilter`, ainsi que leurs équivalents asynchrones.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-144">For example, the [ActionFilterAttribute](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionfilterattribute) abstract class implements both `IActionFilter` and `IResultFilter`, as well as their async equivalents.</span></span>

> [!NOTE]
> <span data-ttu-id="5f0b7-145">Implémentez **soit** synchrones ou la version asynchrone d’une interface de filtre, pas les deux.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-145">Implement **either** the synchronous or the async version of a filter interface, not both.</span></span> <span data-ttu-id="5f0b7-146">Le framework vérifie tout d’abord si le filtre implémente l’interface asynchrone, et si tel est le cas, il appelle qui.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-146">The framework checks first to see if the filter implements the async interface, and if so, it calls that.</span></span> <span data-ttu-id="5f0b7-147">Si ce n’est pas le cas, il appelle les méthodes de l’interface synchrone.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-147">If not, it calls the synchronous interface's method(s).</span></span> <span data-ttu-id="5f0b7-148">Si vous étiez à implémenter les interfaces sur une classe, seule la méthode async est appelée.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-148">If you were to implement both interfaces on one class, only the async method would be called.</span></span> <span data-ttu-id="5f0b7-149">Lors de l’utilisation des classes abstraites comme [ActionFilterAttribute](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionfilterattribute) vous devez remplacer uniquement les méthodes synchrones ou la méthode async pour chaque type de filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-149">When using abstract classes like [ActionFilterAttribute](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionfilterattribute) you would override only the synchronous methods or the async method for each filter type.</span></span>

### <a name="ifilterfactory"></a><span data-ttu-id="5f0b7-150">IFilterFactory</span><span class="sxs-lookup"><span data-stu-id="5f0b7-150">IFilterFactory</span></span>

<span data-ttu-id="5f0b7-151">L'objet `IFilterFactory` implémente l'objet `IFilter`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-151">`IFilterFactory` implements `IFilter`.</span></span> <span data-ttu-id="5f0b7-152">Par conséquent, un `IFilterFactory` instance peut être utilisée comme un `IFilter` instance n’importe où dans le pipeline de filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-152">Therefore, an `IFilterFactory` instance can be used as an `IFilter` instance anywhere in the filter pipeline.</span></span> <span data-ttu-id="5f0b7-153">Lorsque le framework prépare appeler le filtre, il tente d’effectuer un cast en un `IFilterFactory`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-153">When the framework prepares to invoke the filter, it attempts to cast it to an `IFilterFactory`.</span></span> <span data-ttu-id="5f0b7-154">Si cette conversion réussit, le `CreateInstance` méthode est appelée pour créer le `IFilter` instance qui sera appelé.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-154">If that cast succeeds, the `CreateInstance` method is called to create the `IFilter` instance that will be invoked.</span></span> <span data-ttu-id="5f0b7-155">Cela fournit une conception très flexible, étant donné que le pipeline de filtre précis n’a pas besoin d’être défini explicitement, lorsque l’application démarre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-155">This provides a very flexible design, since the precise filter pipeline does not need to be set explicitly when the application starts.</span></span>

<span data-ttu-id="5f0b7-156">Vous pouvez implémenter `IFilterFactory` sur vos propres implémentations d’attribut en tant qu’une autre approche pour la création de filtres :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-156">You can implement `IFilterFactory` on your own attribute implementations as another approach to creating filters:</span></span>

<span data-ttu-id="5f0b7-157">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/AddHeaderWithFactoryAttribute.cs?name=snippet_IFilterFactory&highlight=1,4,5,6,7)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-157">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/AddHeaderWithFactoryAttribute.cs?name=snippet_IFilterFactory&highlight=1,4,5,6,7)]</span></span>

### <a name="built-in-filter-attributes"></a><span data-ttu-id="5f0b7-158">Attributs de filtre intégré</span><span class="sxs-lookup"><span data-stu-id="5f0b7-158">Built-in filter attributes</span></span>

<span data-ttu-id="5f0b7-159">Le framework inclut les filtres intégrés basée sur les attributs que vous pouvez créer une sous-classe et personnaliser.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-159">The framework includes built-in attribute-based filters that you can subclass and customize.</span></span> <span data-ttu-id="5f0b7-160">Par exemple, le filtre de résultat suivant ajoute un en-tête à la réponse.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-160">For example, the following Result filter adds a header to the response.</span></span>

<a name=add-header-attribute></a>

<span data-ttu-id="5f0b7-161">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/AddHeaderAttribute.cs?highlight=5,16)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-161">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/AddHeaderAttribute.cs?highlight=5,16)]</span></span>

<span data-ttu-id="5f0b7-162">Attributs autorise les filtres accepter des arguments, comme indiqué dans l’exemple ci-dessus.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-162">Attributes allow filters to accept arguments, as shown in the example above.</span></span> <span data-ttu-id="5f0b7-163">Vous serez ajoutez cet attribut à une méthode de contrôleur ou d’action et spécifiez le nom et la valeur de l’en-tête HTTP :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-163">You would add this attribute to a controller or action method and specify the name and value of the HTTP header:</span></span>

<span data-ttu-id="5f0b7-164">[!code-csharp[Main](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-164">[!code-csharp[Main](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1)]</span></span>

<span data-ttu-id="5f0b7-165">Le résultat de la `Index` action est illustrée ci-dessous, les en-têtes de réponse sont affichés dans la partie inférieure droite.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-165">The result of the `Index` action is shown below - the response headers are displayed on the bottom right.</span></span>

![Developer Tools de Microsoft Edge affichant les en-têtes de réponse, notamment l’auteur de Steve Smith@ardalis](filters/_static/add-header.png)

<span data-ttu-id="5f0b7-167">Plusieurs des interfaces de filtre ont des attributs correspondants qui peuvent être utilisés comme classes de base pour les implémentations personnalisées.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-167">Several of the filter interfaces have corresponding attributes that can be used as base classes for custom implementations.</span></span>

<span data-ttu-id="5f0b7-168">Attributs de filtre :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-168">Filter attributes:</span></span>

* `ActionFilterAttribute`
* `ExceptionFilterAttribute`
* `ResultFilterAttribute`
* `FormatFilterAttribute`
* `ServiceFilterAttribute`
* `TypeFilterAttribute`

<span data-ttu-id="5f0b7-169">`TypeFilterAttribute`et `ServiceFilterAttribute` sont expliquées [plus loin dans cet article](#dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-169">`TypeFilterAttribute` and `ServiceFilterAttribute` are explained [later in this article](#dependency-injection).</span></span>

## <a name="filter-scopes-and-order-of-execution"></a><span data-ttu-id="5f0b7-170">Les étendues de filtre et ordre d’exécution</span><span class="sxs-lookup"><span data-stu-id="5f0b7-170">Filter scopes and order of execution</span></span>

<span data-ttu-id="5f0b7-171">Un filtre peut être ajouté au pipeline à un des trois *étendues*.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-171">A filter can be added to the pipeline at one of three *scopes*.</span></span> <span data-ttu-id="5f0b7-172">Vous pouvez ajouter un filtre à une méthode d’action particulier ou à une classe de contrôleur à l’aide d’un attribut.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-172">You can add a filter to a particular action method or to a controller class by using an attribute.</span></span> <span data-ttu-id="5f0b7-173">Ou vous pouvez enregistrer un filtre global (pour tous les contrôleurs et les actions) en l’ajoutant à la `MvcOptions.Filters` collection dans le `ConfigureServices` méthode dans la `Startup` classe :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-173">Or you can register a filter globally (for all controllers and actions) by adding it to the `MvcOptions.Filters` collection in the `ConfigureServices` method in the `Startup` class:</span></span>

<span data-ttu-id="5f0b7-174">[!code-csharp[Main](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=5-8)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-174">[!code-csharp[Main](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=5-8)]</span></span>

### <a name="default-order-of-execution"></a><span data-ttu-id="5f0b7-175">Ordre par défaut de l’exécution</span><span class="sxs-lookup"><span data-stu-id="5f0b7-175">Default order of execution</span></span>

<span data-ttu-id="5f0b7-176">Lorsqu’il existe plusieurs filtres pour une étape spécifique du pipeline, la portée détermine l’ordre par défaut de l’exécution du filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-176">When there are multiple filters for a particular stage of the pipeline, scope determines the default order of filter execution.</span></span>  <span data-ttu-id="5f0b7-177">Filtres globaux entourent les filtres de classe, qui à son tour entourent les filtres de la méthode.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-177">Global filters surround class filters, which in turn surround method filters.</span></span> <span data-ttu-id="5f0b7-178">Cela est parfois appelée l’imbrication « Poupée russe », car chaque augmentation dans l’étendue est autour de l’étendue précédente, comme un [d’imbrication poupée](https://en.wikipedia.org/wiki/Matryoshka_doll).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-178">This is sometimes referred to as "Russian doll" nesting, as each increase in scope is wrapped around the previous scope, like a [nesting doll](https://en.wikipedia.org/wiki/Matryoshka_doll).</span></span> <span data-ttu-id="5f0b7-179">En règle générale, vous obtenez le comportement de substitution souhaité sans avoir à déterminer explicitement le classement.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-179">You generally get the desired overriding behavior without having to explicitly determine ordering.</span></span>

<span data-ttu-id="5f0b7-180">À la suite de cette imbrication, le *après* code de filtres s’exécute dans l’ordre inverse de la *avant* code.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-180">As a result of this nesting, the *after* code of filters runs in the reverse order of the *before* code.</span></span> <span data-ttu-id="5f0b7-181">La séquence ressemble à ceci :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-181">The sequence looks like this:</span></span>

* <span data-ttu-id="5f0b7-182">Le *avant* code de filtres appliqués globalement</span><span class="sxs-lookup"><span data-stu-id="5f0b7-182">The *before* code of filters applied globally</span></span>
  * <span data-ttu-id="5f0b7-183">Le *avant* code de filtres appliqués à des contrôleurs</span><span class="sxs-lookup"><span data-stu-id="5f0b7-183">The *before* code of filters applied to controllers</span></span>
    * <span data-ttu-id="5f0b7-184">Le *avant* code des filtres appliqués aux méthodes d’action</span><span class="sxs-lookup"><span data-stu-id="5f0b7-184">The *before* code of filters applied to action methods</span></span>
    * <span data-ttu-id="5f0b7-185">Le *après* code des filtres appliqués aux méthodes d’action</span><span class="sxs-lookup"><span data-stu-id="5f0b7-185">The *after* code of filters applied to action methods</span></span>
  * <span data-ttu-id="5f0b7-186">Le *après* code de filtres appliqués à des contrôleurs</span><span class="sxs-lookup"><span data-stu-id="5f0b7-186">The *after* code of filters applied to controllers</span></span>
* <span data-ttu-id="5f0b7-187">Le *après* code de filtres appliqués globalement</span><span class="sxs-lookup"><span data-stu-id="5f0b7-187">The *after* code of filters applied globally</span></span>
  
<span data-ttu-id="5f0b7-188">Voici un exemple qui illustre l’ordre dans le filtre les méthodes sont appelées synchrones filtres d’Action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-188">Here's an example that illustrates the order in which filter methods are called for synchronous Action filters.</span></span>

| <span data-ttu-id="5f0b7-189">Séquence</span><span class="sxs-lookup"><span data-stu-id="5f0b7-189">Sequence</span></span> | <span data-ttu-id="5f0b7-190">Portée du filtre</span><span class="sxs-lookup"><span data-stu-id="5f0b7-190">Filter scope</span></span> | <span data-ttu-id="5f0b7-191">Filter (méthode)</span><span class="sxs-lookup"><span data-stu-id="5f0b7-191">Filter method</span></span> |
|:--------:|:------------:|:-------------:|
| <span data-ttu-id="5f0b7-192">1</span><span class="sxs-lookup"><span data-stu-id="5f0b7-192">1</span></span> | <span data-ttu-id="5f0b7-193">Global</span><span class="sxs-lookup"><span data-stu-id="5f0b7-193">Global</span></span> | `OnActionExecuting` |
| <span data-ttu-id="5f0b7-194">2</span><span class="sxs-lookup"><span data-stu-id="5f0b7-194">2</span></span> | <span data-ttu-id="5f0b7-195">Contrôleur</span><span class="sxs-lookup"><span data-stu-id="5f0b7-195">Controller</span></span> | `OnActionExecuting` |
| <span data-ttu-id="5f0b7-196">3</span><span class="sxs-lookup"><span data-stu-id="5f0b7-196">3</span></span> | <span data-ttu-id="5f0b7-197">Méthode</span><span class="sxs-lookup"><span data-stu-id="5f0b7-197">Method</span></span> | `OnActionExecuting` |
| <span data-ttu-id="5f0b7-198">4</span><span class="sxs-lookup"><span data-stu-id="5f0b7-198">4</span></span> | <span data-ttu-id="5f0b7-199">Méthode</span><span class="sxs-lookup"><span data-stu-id="5f0b7-199">Method</span></span> | `OnActionExecuted` |
| <span data-ttu-id="5f0b7-200">5</span><span class="sxs-lookup"><span data-stu-id="5f0b7-200">5</span></span> | <span data-ttu-id="5f0b7-201">Contrôleur</span><span class="sxs-lookup"><span data-stu-id="5f0b7-201">Controller</span></span> | `OnActionExecuted` |
| <span data-ttu-id="5f0b7-202">6</span><span class="sxs-lookup"><span data-stu-id="5f0b7-202">6</span></span> | <span data-ttu-id="5f0b7-203">Global</span><span class="sxs-lookup"><span data-stu-id="5f0b7-203">Global</span></span> | `OnActionExecuted` |

<span data-ttu-id="5f0b7-204">Cette séquence montre que le filtre de la méthode est imbriqué dans le filtre de contrôleur et le filtre de contrôleur est imbriqué dans le filtre global.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-204">This sequence shows that the method filter is nested within the controller filter, and the controller filter is nested within the global filter.</span></span> <span data-ttu-id="5f0b7-205">Pour placer une autre façon, si vous êtes à l’intérieur d’un filtre async du*étape*ExecutionAsync méthode, tous les filtres avec une portée plus étroite s’exécuter pendant que votre code est sur la pile.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-205">To put it another way, if you're inside an async filter's On*Stage*ExecutionAsync method, all of the filters with a tighter scope run while your code is on the stack.</span></span>

> [!NOTE]
> <span data-ttu-id="5f0b7-206">Chaque contrôleur qui hérite de la `Controller` inclut de la classe de base `OnActionExecuting` et `OnActionExecuted` méthodes.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-206">Every controller that inherits from the `Controller` base class includes `OnActionExecuting` and `OnActionExecuted` methods.</span></span> <span data-ttu-id="5f0b7-207">Ces méthodes encapsulent les filtres qui s’exécutent pour une action donnée : `OnActionExecuting` est appelée avant que les filtres, et `OnActionExecuted` est appelée après tous les filtres.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-207">These methods wrap the filters that run for a given action:  `OnActionExecuting` is called before any of the filters, and `OnActionExecuted` is called after all of the filters.</span></span>

### <a name="overriding-the-default-order"></a><span data-ttu-id="5f0b7-208">Substitution de l’ordre par défaut</span><span class="sxs-lookup"><span data-stu-id="5f0b7-208">Overriding the default order</span></span>

<span data-ttu-id="5f0b7-209">Vous pouvez remplacer la séquence par défaut de l’exécution en implémentant `IOrderedFilter`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-209">You can override the default sequence of execution by implementing `IOrderedFilter`.</span></span> <span data-ttu-id="5f0b7-210">Cette interface expose un `Order` propriété qui est prioritaire sur l’étendue afin de déterminer l’ordre d’exécution.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-210">This interface exposes an `Order` property that takes precedence over scope to determine the order of execution.</span></span> <span data-ttu-id="5f0b7-211">Un filtre avec une faible `Order` valeur aura son *avant* code exécuté avant que d’un filtre avec une valeur plus élevée de `Order`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-211">A filter with a lower `Order` value will have its *before* code executed before that of a filter with a higher value of `Order`.</span></span> <span data-ttu-id="5f0b7-212">Un filtre avec une faible `Order` valeur aura son *après* le code exécuté par la suite d’un filtre avec un degré plus élevé `Order` valeur.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-212">A filter with a lower `Order` value will have its *after* code executed after that of a filter with a higher `Order` value.</span></span> <span data-ttu-id="5f0b7-213">Vous pouvez définir le `Order` propriété à l’aide d’un paramètre de constructeur :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-213">You can set the `Order` property by using a constructor parameter:</span></span>

```csharp
[MyFilter(Name = "Controller Level Attribute", Order=1)]
```

<span data-ttu-id="5f0b7-214">Si vous avez la même indiqués dans le précédent exemple mais le même jeu de filtres d’Action 3 le `Order` propriété du contrôleur et globaux filtres à 1 et 2, respectivement, l’ordre d’exécution est inversé.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-214">If you have the same 3 Action filters shown in the preceding example but set the `Order` property of the controller and global filters to 1 and 2 respectively, the order of execution would be reversed.</span></span>

| <span data-ttu-id="5f0b7-215">Séquence</span><span class="sxs-lookup"><span data-stu-id="5f0b7-215">Sequence</span></span> | <span data-ttu-id="5f0b7-216">Portée du filtre</span><span class="sxs-lookup"><span data-stu-id="5f0b7-216">Filter scope</span></span> | <span data-ttu-id="5f0b7-217">Propriété `Order`</span><span class="sxs-lookup"><span data-stu-id="5f0b7-217">`Order` property</span></span> | <span data-ttu-id="5f0b7-218">Filter (méthode)</span><span class="sxs-lookup"><span data-stu-id="5f0b7-218">Filter method</span></span> |
|:--------:|:------------:|:-----------------:|:-------------:|
| <span data-ttu-id="5f0b7-219">1</span><span class="sxs-lookup"><span data-stu-id="5f0b7-219">1</span></span> | <span data-ttu-id="5f0b7-220">Méthode</span><span class="sxs-lookup"><span data-stu-id="5f0b7-220">Method</span></span> | <span data-ttu-id="5f0b7-221">0</span><span class="sxs-lookup"><span data-stu-id="5f0b7-221">0</span></span> | `OnActionExecuting` |
| <span data-ttu-id="5f0b7-222">2</span><span class="sxs-lookup"><span data-stu-id="5f0b7-222">2</span></span> | <span data-ttu-id="5f0b7-223">Contrôleur</span><span class="sxs-lookup"><span data-stu-id="5f0b7-223">Controller</span></span> | <span data-ttu-id="5f0b7-224">1</span><span class="sxs-lookup"><span data-stu-id="5f0b7-224">1</span></span>  | `OnActionExecuting` |
| <span data-ttu-id="5f0b7-225">3</span><span class="sxs-lookup"><span data-stu-id="5f0b7-225">3</span></span> | <span data-ttu-id="5f0b7-226">Global</span><span class="sxs-lookup"><span data-stu-id="5f0b7-226">Global</span></span> | <span data-ttu-id="5f0b7-227">2</span><span class="sxs-lookup"><span data-stu-id="5f0b7-227">2</span></span>  | `OnActionExecuting` |
| <span data-ttu-id="5f0b7-228">4</span><span class="sxs-lookup"><span data-stu-id="5f0b7-228">4</span></span> | <span data-ttu-id="5f0b7-229">Global</span><span class="sxs-lookup"><span data-stu-id="5f0b7-229">Global</span></span> | <span data-ttu-id="5f0b7-230">2</span><span class="sxs-lookup"><span data-stu-id="5f0b7-230">2</span></span>  | `OnActionExecuted` |
| <span data-ttu-id="5f0b7-231">5</span><span class="sxs-lookup"><span data-stu-id="5f0b7-231">5</span></span> | <span data-ttu-id="5f0b7-232">Contrôleur</span><span class="sxs-lookup"><span data-stu-id="5f0b7-232">Controller</span></span> | <span data-ttu-id="5f0b7-233">1</span><span class="sxs-lookup"><span data-stu-id="5f0b7-233">1</span></span>  | `OnActionExecuted` |
| <span data-ttu-id="5f0b7-234">6</span><span class="sxs-lookup"><span data-stu-id="5f0b7-234">6</span></span> | <span data-ttu-id="5f0b7-235">Méthode</span><span class="sxs-lookup"><span data-stu-id="5f0b7-235">Method</span></span> | <span data-ttu-id="5f0b7-236">0</span><span class="sxs-lookup"><span data-stu-id="5f0b7-236">0</span></span>  | `OnActionExecuted` |

<span data-ttu-id="5f0b7-237">Le `Order` propriété éclipsent mille paires d’étendue lors de la détermination de l’ordre dans lequel les filtres seront exécutent.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-237">The `Order` property trumps scope when determining the order in which filters will run.</span></span> <span data-ttu-id="5f0b7-238">Les filtres sont triés en premier par ordre, puis étendue permet de rompre les liens.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-238">Filters are sorted first by order, then scope is used to break ties.</span></span> <span data-ttu-id="5f0b7-239">Tous les filtres intégrés implémentent `IOrderedFilter` et définissez la valeur par défaut `Order` la valeur 0, la portée détermine l’ordre, sauf si vous définissez `Order` à une valeur différente de zéro.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-239">All of the built-in filters implement `IOrderedFilter` and set the default `Order` value to 0, so scope determines order unless you set `Order` to a non-zero value.</span></span>

## <a name="cancellation-and-short-circuiting"></a><span data-ttu-id="5f0b7-240">L’annulation et court-circuit</span><span class="sxs-lookup"><span data-stu-id="5f0b7-240">Cancellation and short circuiting</span></span>

<span data-ttu-id="5f0b7-241">Vous pouvez court-circuit le pipeline de filtre à tout moment en définissant le `Result` propriété sur le `context` paramètre fourni à la méthode de filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-241">You can short-circuit the filter pipeline at any point by setting the `Result` property on the `context` parameter provided to the filter method.</span></span> <span data-ttu-id="5f0b7-242">Par exemple, le filtre de ressource suivant empêche le reste du pipeline de l’exécution.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-242">For instance, the following Resource filter prevents the rest of the pipeline from executing.</span></span>

<a name=short-circuiting-resource-filter></a>

<span data-ttu-id="5f0b7-243">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/ShortCircuitingResourceFilterAttribute.cs?highlight=12,13,14,15)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-243">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/ShortCircuitingResourceFilterAttribute.cs?highlight=12,13,14,15)]</span></span>

<span data-ttu-id="5f0b7-244">Dans le code suivant, à la fois le `ShortCircuitingResourceFilter` et `AddHeader` cible de filtre la `SomeResource` méthode d’action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-244">In the following code, both the `ShortCircuitingResourceFilter` and the `AddHeader` filter target the `SomeResource` action method.</span></span> <span data-ttu-id="5f0b7-245">Toutefois, étant donné que la `ShortCircuitingResourceFilter` s’exécute en premier (, car il s’agit d’un filtre de ressources et `AddHeader` est un filtre d’Action) et court-circuite le reste du pipeline, le `AddHeader` filtre ne s’exécute jamais pour le `SomeResource` action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-245">However, because the `ShortCircuitingResourceFilter` runs first (because it is a Resource Filter and `AddHeader` is an Action Filter) and short-circuits the rest of the pipeline, the `AddHeader` filter never runs for the `SomeResource` action.</span></span> <span data-ttu-id="5f0b7-246">Ce comportement serait identique si les deux filtres ont été appliquées au niveau de la méthode action, fourni le `ShortCircuitingResourceFilter` a exécuté la première (en raison de son type de filtre, ou explicite, utilisez des `Order` propriété, par exemple).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-246">This behavior would be the same if both filters were applied at the action method level, provided the `ShortCircuitingResourceFilter` ran first (because of its filter type, or explicit use of `Order` property, for instance).</span></span>

<span data-ttu-id="5f0b7-247">[!code-csharp[Main](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1,9)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-247">[!code-csharp[Main](./filters/sample/src/FiltersSample/Controllers/SampleController.cs?name=snippet_AddHeader&highlight=1,9)]</span></span>

## <a name="dependency-injection"></a><span data-ttu-id="5f0b7-248">Injection de dépendance</span><span class="sxs-lookup"><span data-stu-id="5f0b7-248">Dependency injection</span></span>

<span data-ttu-id="5f0b7-249">Filtres peuvent être ajoutés par type ou par instance.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-249">Filters can be added by type or by instance.</span></span> <span data-ttu-id="5f0b7-250">Si vous ajoutez une instance, cette instance sera utilisée pour chaque demande.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-250">If you add an instance, that instance will be used for every request.</span></span> <span data-ttu-id="5f0b7-251">Si vous ajoutez un type, il sera activé par type, ce qui signifie une instance sera créée pour chaque demande et toutes les dépendances de constructeur seront remplies par [injection de dépendance](../../fundamentals/dependency-injection.md) (DI).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-251">If you add a type, it will be type-activated, meaning an instance will be created for each request and any constructor dependencies will be populated by [dependency injection](../../fundamentals/dependency-injection.md) (DI).</span></span> <span data-ttu-id="5f0b7-252">Ajout d’un filtre par type équivaut à `filters.Add(new TypeFilterAttribute(typeof(MyFilter)))`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-252">Adding a filter by type is equivalent to `filters.Add(new TypeFilterAttribute(typeof(MyFilter)))`.</span></span>

<span data-ttu-id="5f0b7-253">Les filtres qui sont implémentées en tant qu’attributs et ajoutés directement à des classes de contrôleur ou de méthodes d’action ne peut pas avoir de dépendances de constructeur fournis par [injection de dépendance](../../fundamentals/dependency-injection.md) (DI).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-253">Filters that are implemented as attributes and added directly to controller classes or action methods cannot have constructor dependencies provided by [dependency injection](../../fundamentals/dependency-injection.md) (DI).</span></span> <span data-ttu-id="5f0b7-254">Il s’agit, car les attributs doivent avoir leurs paramètres du constructeur fournis où elles sont appliquées.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-254">This is because attributes must have their constructor parameters supplied where they are applied.</span></span> <span data-ttu-id="5f0b7-255">Il s’agit d’une limitation du mode de fonctionnement des attributs.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-255">This is a limitation of how attributes work.</span></span>

<span data-ttu-id="5f0b7-256">Si vos filtres ont des dépendances dont vous avez besoin pour accéder à partir de DI, il existe plusieurs approches pris en charge.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-256">If your filters have dependencies that you need to access from DI, there are several supported approaches.</span></span> <span data-ttu-id="5f0b7-257">Vous pouvez appliquer le filtre à une méthode de classe ou une action à l’aide d’une des opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-257">You can apply your filter to a class or action method using one of the following:</span></span>

* `ServiceFilterAttribute`
* `TypeFilterAttribute`
* <span data-ttu-id="5f0b7-258">`IFilterFactory`implémenté sur votre attribut</span><span class="sxs-lookup"><span data-stu-id="5f0b7-258">`IFilterFactory` implemented on your attribute</span></span>

> [!NOTE]
> <span data-ttu-id="5f0b7-259">Une dépendance, que vous souhaiterez peut-être obtenir à partir de DI est un enregistreur d’événements.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-259">One dependency you might want to get from DI is a logger.</span></span> <span data-ttu-id="5f0b7-260">Toutefois, évitez la création et l’utilisation de filtres uniquement à des fins de journalisation, étant donné que la [des fonctionnalités de journalisation de l’infrastructure intégrée](../../fundamentals/logging.md) offrent parfois ce dont vous avez besoin.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-260">However, avoid creating and using filters purely for logging purposes, since the [built-in framework logging features](../../fundamentals/logging.md) may already provide what you need.</span></span> <span data-ttu-id="5f0b7-261">Si vous souhaitez ajouter à vos filtres, il doit se concentrer sur les problèmes de domaine d’entreprise ou de comportement spécifique à votre filtre, plutôt que des actions de MVC ou d’autres événements de framework.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-261">If you're going to add logging to your filters, it should focus on business domain concerns or behavior specific to your filter, rather than MVC actions or other framework events.</span></span>

### <a name="servicefilterattribute"></a><span data-ttu-id="5f0b7-262">ServiceFilterAttribute</span><span class="sxs-lookup"><span data-stu-id="5f0b7-262">ServiceFilterAttribute</span></span>

<span data-ttu-id="5f0b7-263">A `ServiceFilter` récupère une instance du filtre DI.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-263">A `ServiceFilter` retrieves an instance of the filter from DI.</span></span> <span data-ttu-id="5f0b7-264">Vous ajoutez le filtre sur le conteneur dans `ConfigureServices`et à le référencer dans un `ServiceFilter` attribut</span><span class="sxs-lookup"><span data-stu-id="5f0b7-264">You add the filter to the container in `ConfigureServices`, and reference it in a `ServiceFilter` attribute</span></span>

<span data-ttu-id="5f0b7-265">[!code-csharp[Main](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=11)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-265">[!code-csharp[Main](./filters/sample/src/FiltersSample/Startup.cs?name=snippet_ConfigureServices&highlight=11)]</span></span>

<span data-ttu-id="5f0b7-266">[!code-csharp[Main](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_ServiceFilter&highlight=1)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-266">[!code-csharp[Main](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_ServiceFilter&highlight=1)]</span></span>

<span data-ttu-id="5f0b7-267">À l’aide de `ServiceFilter` sans enregistrer les résultats de type de filtre dans une exception :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-267">Using `ServiceFilter` without registering the filter type results in an exception:</span></span>

```
System.InvalidOperationException: No service for type
'FiltersSample.Filters.AddHeaderFilterWithDI' has been registered.
```

<span data-ttu-id="5f0b7-268">`ServiceFilterAttribute`implémente `IFilterFactory`, qui expose une méthode unique pour la création d’un `IFilter` instance.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-268">`ServiceFilterAttribute` implements `IFilterFactory`, which exposes a single method for creating an `IFilter` instance.</span></span> <span data-ttu-id="5f0b7-269">Dans le cas de `ServiceFilterAttribute`, le `IFilterFactory` l’interface `CreateInstance` méthode est implémentée pour charger le type spécifié à partir du conteneur de services (DI).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-269">In the case of `ServiceFilterAttribute`, the `IFilterFactory` interface's `CreateInstance` method is implemented to load the specified type from the services container (DI).</span></span>

### <a name="typefilterattribute"></a><span data-ttu-id="5f0b7-270">TypeFilterAttribute</span><span class="sxs-lookup"><span data-stu-id="5f0b7-270">TypeFilterAttribute</span></span>

<span data-ttu-id="5f0b7-271">`TypeFilterAttribute`est très similaire à `ServiceFilterAttribute` (et implémente également `IFilterFactory`), mais son type n’est pas résolu directement à partir du conteneur DI.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-271">`TypeFilterAttribute` is very similar to `ServiceFilterAttribute` (and also implements `IFilterFactory`), but its type is not resolved directly from the DI container.</span></span> <span data-ttu-id="5f0b7-272">Au lieu de cela, il instancie le type à l’aide de `Microsoft.Extensions.DependencyInjection.ObjectFactory`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-272">Instead, it instantiates the type by using `Microsoft.Extensions.DependencyInjection.ObjectFactory`.</span></span>

<span data-ttu-id="5f0b7-273">En raison de cette différence, les types qui sont référencés à l’aide de la `TypeFilterAttribute` n’avez pas besoin être enregistrée avec le conteneur (mais toujours auront leurs dépendances remplies par le conteneur).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-273">Because of this difference, types that are referenced using the `TypeFilterAttribute` do not need to be registered with the container first (but they will still have their dependencies fulfilled by the container).</span></span> <span data-ttu-id="5f0b7-274">En outre, `TypeFilterAttribute` peut éventuellement accepter des arguments de constructeur pour le type en question.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-274">Also, `TypeFilterAttribute` can optionally accept constructor arguments for the type in question.</span></span> <span data-ttu-id="5f0b7-275">L’exemple suivant montre comment passer des arguments à un type à l’aide de `TypeFilterAttribute`:</span><span class="sxs-lookup"><span data-stu-id="5f0b7-275">The following example demonstrates how to pass arguments to a type using `TypeFilterAttribute`:</span></span>

<span data-ttu-id="5f0b7-276">[!code-csharp[Main](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_TypeFilter&highlight=1,2)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-276">[!code-csharp[Main](../../mvc/controllers/filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_TypeFilter&highlight=1,2)]</span></span>

<span data-ttu-id="5f0b7-277">Si vous avez un filtre qui ne nécessite pas d’arguments, mais qui a des dépendances de constructeur qui doivent être remplies par DI, vous pouvez utiliser votre propre attribut nommé sur les classes et méthodes au lieu de `[TypeFilter(typeof(FilterType))]`).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-277">If you have a filter that doesn't require any arguments, but which has constructor dependencies that need to be filled by DI, you can use your own named attribute on classes and methods instead of `[TypeFilter(typeof(FilterType))]`).</span></span> <span data-ttu-id="5f0b7-278">Le filtre suivant montre comment cela peut être implémenté :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-278">The following filter shows how this can be implemented:</span></span>

<span data-ttu-id="5f0b7-279">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleActionFilterAttribute.cs?name=snippet_TypeFilterAttribute&highlight=1,3,7)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-279">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleActionFilterAttribute.cs?name=snippet_TypeFilterAttribute&highlight=1,3,7)]</span></span>

<span data-ttu-id="5f0b7-280">Ce filtre peut être appliqué aux classes ou méthodes à l’aide de la `[SampleActionFilter]` syntaxe, au lieu de devoir utiliser `[TypeFilter]` ou `[ServiceFilter]`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-280">This filter can be applied to classes or methods using the `[SampleActionFilter]` syntax, instead of having to use `[TypeFilter]` or `[ServiceFilter]`.</span></span>

## <a name="authorization-filters"></a><span data-ttu-id="5f0b7-281">Filtres d’autorisation</span><span class="sxs-lookup"><span data-stu-id="5f0b7-281">Authorization filters</span></span>

<span data-ttu-id="5f0b7-282">*Filtres d’autorisation* contrôler l’accès aux méthodes d’action et le premier filtre à exécuter dans le pipeline de filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-282">*Authorization filters* control access to action methods and are the first filters to be executed within the filter pipeline.</span></span> <span data-ttu-id="5f0b7-283">Ils ont uniquement un avant de méthode, contrairement à la plupart des filtres qui prennent en charge avant et après les méthodes.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-283">They have only a before method, unlike most filters that support before and after methods.</span></span> <span data-ttu-id="5f0b7-284">Vous devez uniquement écrire un filtre d’autorisation personnalisée si vous écrivez votre propre infrastructure d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-284">You should only write a custom authorization filter if you are writing your own authorization framework.</span></span> <span data-ttu-id="5f0b7-285">Préférez la configuration de vos stratégies d’autorisation ou de l’écriture d’une stratégie d’autorisation personnalisée sur l’écriture d’un filtre personnalisé.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-285">Prefer configuring your authorization policies or writing a custom authorization policy over writing a custom filter.</span></span> <span data-ttu-id="5f0b7-286">L’implémentation de filtre intégré est simplement chargée d’appeler le système d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-286">The built-in filter implementation is just responsible for calling the authorization system.</span></span>

<span data-ttu-id="5f0b7-287">Notez que vous ne devez pas lever d’exceptions dans les filtres d’autorisation, étant donné que rien ne gère l’exception (filtres d’exception ne sont pas les gérer).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-287">Note that you should not throw exceptions within authorization filters, since nothing will handle the exception (exception filters won't handle them).</span></span> <span data-ttu-id="5f0b7-288">Au lieu de cela, émettre une demande d’accès ou d’autre moyen.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-288">Instead, issue a challenge or find another way.</span></span>

<span data-ttu-id="5f0b7-289">En savoir plus sur [autorisation](../../security/authorization/index.md).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-289">Learn more about [Authorization](../../security/authorization/index.md).</span></span>

## <a name="resource-filters"></a><span data-ttu-id="5f0b7-290">Filtres de ressources</span><span class="sxs-lookup"><span data-stu-id="5f0b7-290">Resource filters</span></span>

<span data-ttu-id="5f0b7-291">*Filtres de ressources* implémentent la `IResourceFilter` ou `IAsyncResourceFilter` interface et leur exécution encapsule la majeure partie du pipeline de filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-291">*Resource filters* implement either the `IResourceFilter` or `IAsyncResourceFilter` interface, and their execution wraps most of the filter pipeline.</span></span> <span data-ttu-id="5f0b7-292">(Uniquement [filtres d’autorisation](#authorization-filters) exécuter avant eux.) Filtres de ressources sont particulièrement utiles si vous avez besoin pour la plupart du travail effectue une demande de court-circuit.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-292">(Only [Authorization filters](#authorization-filters) run before them.) Resource filters are especially useful if you need to short-circuit most of the work a request is doing.</span></span> <span data-ttu-id="5f0b7-293">Par exemple, un filtre de mise en cache peut éviter le reste du pipeline si la réponse est déjà dans le cache.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-293">For example, a caching filter can avoid the rest of the pipeline if the response is already in the cache.</span></span>

<span data-ttu-id="5f0b7-294">Le [court filtre ressource court-circuit](#short-circuiting-resource-filter) présentée précédemment est un exemple d’un filtre de ressource.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-294">The [short circuiting resource filter](#short-circuiting-resource-filter) shown earlier is one example of a resource filter.</span></span> <span data-ttu-id="5f0b7-295">Un autre exemple est [DisableFormValueModelBindingAttribute](https://github.com/aspnet/Entropy/blob/rel/1.1.1/samples/Mvc.FileUpload/Filters/DisableFormValueModelBindingAttribute.cs), ce qui empêche la liaison de modèle à partir de l’accès aux données de formulaire.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-295">Another example is [DisableFormValueModelBindingAttribute](https://github.com/aspnet/Entropy/blob/rel/1.1.1/samples/Mvc.FileUpload/Filters/DisableFormValueModelBindingAttribute.cs), which prevents model binding from accessing the form data.</span></span> <span data-ttu-id="5f0b7-296">Il est utile pour les cas où vous savez que vous allez recevoir le téléchargement de fichiers volumineux et pour empêcher que le formulaire qui est lue en mémoire.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-296">It's useful for cases where you know that you're going to receive large file uploads and want to prevent the form from being read into memory.</span></span>

## <a name="action-filters"></a><span data-ttu-id="5f0b7-297">Filtres d’action</span><span class="sxs-lookup"><span data-stu-id="5f0b7-297">Action filters</span></span>

<span data-ttu-id="5f0b7-298">*Filtres d’action* implémentent la `IActionFilter` ou `IAsyncActionFilter` interface et leur exécution entoure l’exécution de méthodes d’action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-298">*Action filters* implement either the `IActionFilter` or `IAsyncActionFilter` interface, and their execution surrounds the execution of action methods.</span></span>

<span data-ttu-id="5f0b7-299">Voici un exemple de filtre d’action :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-299">Here's a sample action filter:</span></span>

<span data-ttu-id="5f0b7-300">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?name=snippet_ActionFilter)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-300">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/SampleActionFilter.cs?name=snippet_ActionFilter)]</span></span>

<span data-ttu-id="5f0b7-301">Le [ActionExecutingContext](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionexecutingcontext) fournit les propriétés suivantes :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-301">The [ActionExecutingContext](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionexecutingcontext) provides the following properties:</span></span>

* <span data-ttu-id="5f0b7-302">`ActionArguments`-vous permet de manipuler les entrées de l’action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-302">`ActionArguments` - lets you manipulate the inputs to the action.</span></span>
* <span data-ttu-id="5f0b7-303">`Controller`-vous permet de manipuler l’instance du contrôleur.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-303">`Controller` - lets you manipulate the controller instance.</span></span> 
* <span data-ttu-id="5f0b7-304">`Result`-la définition de cette court-circuite l’exécution de la méthode d’action et les filtres d’action suivants.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-304">`Result` - setting this short-circuits execution of the action method and subsequent action filters.</span></span> <span data-ttu-id="5f0b7-305">Lever une exception également empêche l’exécution de la méthode d’action et les autres filtres, mais est traité comme une erreur au lieu d’un résultat réussi.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-305">Throwing an exception also prevents execution of the action method and subsequent filters, but is treated as a failure instead of a successful result.</span></span>

<span data-ttu-id="5f0b7-306">Le [ActionExecutedContext](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionexecutedcontext) fournit `Controller` et `Result` ainsi que les propriétés suivantes :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-306">The [ActionExecutedContext](https://docs.microsoft.com/aspnet/core/api/microsoft.aspnetcore.mvc.filters.actionexecutedcontext) provides `Controller` and `Result` plus the following properties:</span></span>

* <span data-ttu-id="5f0b7-307">`Canceled`-la valeur est True si l’exécution de l’action a été court-circuité par un autre filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-307">`Canceled` - will be true if the action execution was short-circuited by another filter.</span></span>
* <span data-ttu-id="5f0b7-308">`Exception`-sera non null si l’action ou un filtre d’action suivants a levé une exception.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-308">`Exception` - will be non-null if the action or a subsequent action filter threw an exception.</span></span> <span data-ttu-id="5f0b7-309">Définition de cette propriété sur null efficacement 'handles' une exception, et `Result` sera exécutée comme si elle a été retournée à partir de la méthode d’action normalement.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-309">Setting this property to null effectively 'handles' an exception, and `Result` will be executed as if it were returned from the action method normally.</span></span>

<span data-ttu-id="5f0b7-310">Pour un `IAsyncActionFilter`, un appel à la `ActionExecutionDelegate` exécute tous les filtres d’action suivants et la méthode d’action, en retournant un `ActionExecutedContext`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-310">For an `IAsyncActionFilter`, a call to the `ActionExecutionDelegate` executes any subsequent action filters and the action method, returning an `ActionExecutedContext`.</span></span> <span data-ttu-id="5f0b7-311">Pour de court-circuit, assignez `ActionExecutingContext.Result` à un résultat de l’instance et n’appelez pas la `ActionExecutionDelegate`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-311">To short-circuit, assign `ActionExecutingContext.Result` to some result instance and do not call the `ActionExecutionDelegate`.</span></span>

<span data-ttu-id="5f0b7-312">Le framework fournit un résumé `ActionFilterAttribute` que vous pouvez créer une sous-classe.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-312">The framework provides an abstract `ActionFilterAttribute` that you can subclass.</span></span> 

<span data-ttu-id="5f0b7-313">Vous pouvez utiliser un filtre d’action automatiquement valider l’état du modèle et retourner des erreurs si l’état n’est pas valide :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-313">You can use an action filter to automatically validate model state and return any errors if the state is invalid:</span></span>

<span data-ttu-id="5f0b7-314">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/ValidateModelAttribute.cs)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-314">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/ValidateModelAttribute.cs)]</span></span>

<span data-ttu-id="5f0b7-315">Le `OnActionExecuted` s’exécute la méthode après la méthode d’action et peut voir et de manipuler les résultats de l’action via le `ActionExecutedContext.Result` propriété.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-315">The `OnActionExecuted` method runs after the action method and can see and manipulate the results of the action through the `ActionExecutedContext.Result` property.</span></span> <span data-ttu-id="5f0b7-316">`ActionExecutedContext.Canceled`définira sur true si l’exécution de l’action a été court-circuité par un autre filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-316">`ActionExecutedContext.Canceled` will be set to true if the action execution was short-circuited by another filter.</span></span> <span data-ttu-id="5f0b7-317">`ActionExecutedContext.Exception`est fixé à une valeur non null si l’action ou un filtre d’action suivants a levé une exception.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-317">`ActionExecutedContext.Exception` will be set to a non-null value if the action or a subsequent action filter threw an exception.</span></span> <span data-ttu-id="5f0b7-318">Paramètre `ActionExecutedContext.Exception` NULL efficacement une exception, 'handles' et `ActionExectedContext.Result` est exécutée comme si elle a été retournée à partir de la méthode d’action normalement.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-318">Setting `ActionExecutedContext.Exception` to null effectively 'handles' an exception, and `ActionExectedContext.Result` will then be executed as if it were returned from the action method normally.</span></span>

## <a name="exception-filters"></a><span data-ttu-id="5f0b7-319">Filtres d’exception</span><span class="sxs-lookup"><span data-stu-id="5f0b7-319">Exception filters</span></span>

<span data-ttu-id="5f0b7-320">*Filtres d’exception* implémentent la `IExceptionFilter` ou `IAsyncExceptionFilter` interface.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-320">*Exception filters* implement either the `IExceptionFilter` or `IAsyncExceptionFilter` interface.</span></span> <span data-ttu-id="5f0b7-321">Ils peuvent être utilisés pour implémenter les erreurs courantes la gestion des stratégies pour une application.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-321">They can be used to implement common error handling policies for an app.</span></span> 

<span data-ttu-id="5f0b7-322">L’exemple de filtre d’exception suivant utilise une erreur développeur personnalisé pour afficher des détails sur les exceptions qui se produisent lorsque l’application est en cours de développement :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-322">The following sample exception filter uses a custom developer error view to display details about exceptions that occur when the application is in development:</span></span>

<span data-ttu-id="5f0b7-323">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/CustomExceptionFilterAttribute.cs?name=snippet_ExceptionFilter&highlight=1,14)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-323">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/CustomExceptionFilterAttribute.cs?name=snippet_ExceptionFilter&highlight=1,14)]</span></span>

<span data-ttu-id="5f0b7-324">Filtres d’exception n’ont pas de deux événements (avant ou après) : ils implémentent uniquement `OnException` (ou `OnExceptionAsync`).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-324">Exception filters do not have two events (for before and after) - they only implement `OnException` (or `OnExceptionAsync`).</span></span> 

<span data-ttu-id="5f0b7-325">Gérer les filtres d’exception des exceptions non gérées qui se produisent dans la création du contrôleur, [liaison de modèle](../models/model-binding.md), filtres d’action ou des méthodes d’action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-325">Exception filters handle unhandled exceptions that occur in controller creation, [model binding](../models/model-binding.md), action filters, or action methods.</span></span> <span data-ttu-id="5f0b7-326">Ils ne sont pas intercepter des exceptions qui se produisent dans les filtres de ressources, les filtres de résultat ou l’exécution du résultat de MVC.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-326">They won't catch exceptions that occur in Resource filters, Result filters, or MVC Result execution.</span></span>

<span data-ttu-id="5f0b7-327">Pour gérer une exception, définissez la `ExceptionContext.ExceptionHandled` la propriété ou écrire une réponse.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-327">To handle an exception, set the `ExceptionContext.ExceptionHandled` property to true or write a response.</span></span> <span data-ttu-id="5f0b7-328">Cela arrête la propagation de l’exception.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-328">This stops propagation of the exception.</span></span> <span data-ttu-id="5f0b7-329">Notez qu’un filtre d’Exception ne peut pas activer une exception dans un « succès ».</span><span class="sxs-lookup"><span data-stu-id="5f0b7-329">Note that an Exception filter can't turn an exception into a "success".</span></span> <span data-ttu-id="5f0b7-330">Un filtre d’Action peut le faire.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-330">Only an Action filter can do that.</span></span>

> [!NOTE]
> <span data-ttu-id="5f0b7-331">Dans la version 1.1 d’ASP.NET, la réponse n’est pas envoyée si vous définissez `ExceptionHandled` true **et** écrire une réponse.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-331">In ASP.NET 1.1, the response is not sent if you set `ExceptionHandled` to true **and** write a response.</span></span> <span data-ttu-id="5f0b7-332">Dans ce scénario, ASP.NET Core 1.0 envoie la réponse et ASP.NET Core 1.1.2 retournera le comportement de 1.0.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-332">In that scenario, ASP.NET Core 1.0 does send the response, and ASP.NET Core 1.1.2 will return to the 1.0 behavior.</span></span> <span data-ttu-id="5f0b7-333">Pour plus d’informations, consultez [émettre #5594](https://github.com/aspnet/Mvc/issues/5594) dans le référentiel GitHub.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-333">For more information, see [issue #5594](https://github.com/aspnet/Mvc/issues/5594) in the GitHub repository.</span></span> 

<span data-ttu-id="5f0b7-334">Filtres d’exception sont adaptés pour intercepter les exceptions qui se produisent dans les actions de MVC, mais ils ne sont pas aussi flexibles que l’intergiciel (middleware) de gestion des erreurs.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-334">Exception filters are good for trapping exceptions that occur within MVC actions, but they're not as flexible as error handling middleware.</span></span> <span data-ttu-id="5f0b7-335">Préférez l’intergiciel (middleware) pour le cas général et utiliser des filtres uniquement où vous avez besoin pour gérer les erreurs *différemment* en fonction de l’action MVC a été choisie.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-335">Prefer middleware for the general case, and use filters only where you need to do error handling *differently* based on which MVC action was chosen.</span></span> <span data-ttu-id="5f0b7-336">Par exemple, votre application peut comporter des méthodes d’action pour les deux points de terminaison d’API et de vues/HTML.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-336">For example, your app might have action methods for both API endpoints and for views/HTML.</span></span> <span data-ttu-id="5f0b7-337">Les points de terminaison API peut retourner des informations d’erreur au format JSON, tandis que les actions basée sur une vue peut retourner une page d’erreur au format HTML.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-337">The API endpoints could return error information as JSON, while the view-based actions could return an error page as HTML.</span></span>

<span data-ttu-id="5f0b7-338">Le framework fournit un résumé `ExceptionFilterAttribute` que vous pouvez créer une sous-classe.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-338">The framework provides an abstract `ExceptionFilterAttribute` that you can subclass.</span></span> 

## <a name="result-filters"></a><span data-ttu-id="5f0b7-339">Filtres de résultat</span><span class="sxs-lookup"><span data-stu-id="5f0b7-339">Result filters</span></span>

<span data-ttu-id="5f0b7-340">*Filtres de résultat* implémentent le le `IResultFilter` ou `IAsyncResultFilter` interface et leur exécution entoure l’exécution de résultats d’action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-340">*Result filters* implement either the `IResultFilter` or `IAsyncResultFilter` interface, and their execution surrounds the execution of action results.</span></span> 

<span data-ttu-id="5f0b7-341">Voici un exemple de filtre de résultat qui ajoute un en-tête HTTP.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-341">Here's an example of a Result filter that adds an HTTP header.</span></span>

<span data-ttu-id="5f0b7-342">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/LoggingAddHeaderFilter.cs?name=snippet_ResultFilter)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-342">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/LoggingAddHeaderFilter.cs?name=snippet_ResultFilter)]</span></span>

<span data-ttu-id="5f0b7-343">Le type de résultat en cours d’exécution dépend de l’action en question.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-343">The kind of result being executed depends on the action in question.</span></span> <span data-ttu-id="5f0b7-344">Une action MVC retournant une vue inclut tous les razor de traitement dans le cadre de la `ViewResult` en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-344">An MVC action returning a view would include all razor processing as part of the `ViewResult` being executed.</span></span> <span data-ttu-id="5f0b7-345">Une méthode d’API peut effectuer une sérialisation dans le cadre de l’exécution du résultat.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-345">An API method might perform some serialization as part of the execution of the result.</span></span> <span data-ttu-id="5f0b7-346">En savoir plus sur [résultats d’action](actions.md)</span><span class="sxs-lookup"><span data-stu-id="5f0b7-346">Learn more about [action results](actions.md)</span></span>

<span data-ttu-id="5f0b7-347">Filtres de résultat sont exécutées uniquement pour les résultats réussis - lorsque l’action ou les filtres d’action produisent un résultat d’action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-347">Result filters are only executed for successful results - when the action or action filters produce an action result.</span></span> <span data-ttu-id="5f0b7-348">Filtres de résultat ne sont pas exécutées lorsque les filtres d’exception gérer une exception.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-348">Result filters are not executed when exception filters handle an exception.</span></span>

<span data-ttu-id="5f0b7-349">Le `OnResultExecuting` méthode pouvez court-circuit l’exécution du résultat d’action et les filtres de résultats suivants en définissant `ResultExecutingContext.Cancel` sur true.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-349">The `OnResultExecuting` method can short-circuit execution of the action result and subsequent result filters by setting `ResultExecutingContext.Cancel` to true.</span></span> <span data-ttu-id="5f0b7-350">Vous devez généralement écrire à l’objet de réponse lors de court-circuit pour éviter de générer une réponse vide.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-350">You should generally write to the response object when short-circuiting to avoid generating an empty response.</span></span> <span data-ttu-id="5f0b7-351">Lever une exception sera également empêcher l’exécution du résultat d’action et des autres filtres, mais sera traité comme un échec au lieu d’un résultat réussi.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-351">Throwing an exception will also prevent execution of the action result and subsequent filters, but will be treated as a failure instead of a successful result.</span></span>

<span data-ttu-id="5f0b7-352">Lorsque le `OnResultExecuted` s’exécute (méthode), la réponse a probablement été envoyé au client et ne peut pas être modifiée plus (sauf si une exception a été levée).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-352">When the `OnResultExecuted` method runs, the response has likely been sent to the client and cannot be changed further (unless an exception was thrown).</span></span> <span data-ttu-id="5f0b7-353">`ResultExecutedContext.Canceled`définira sur true si l’exécution de résultat d’action a été court-circuité par un autre filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-353">`ResultExecutedContext.Canceled` will be set to true if the action result execution was short-circuited by another filter.</span></span>

<span data-ttu-id="5f0b7-354">`ResultExecutedContext.Exception`est fixé à une valeur non null si le résultat d’action ou un filtre de résultats suivants a levé une exception.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-354">`ResultExecutedContext.Exception` will be set to a non-null value if the action result or a subsequent result filter threw an exception.</span></span> <span data-ttu-id="5f0b7-355">Paramètre `Exception` à null 'handles' une exception efficacement et empêche l’exception qui est à nouveau levée par MVC plus loin dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-355">Setting `Exception` to null effectively 'handles' an exception and prevents the exception from being rethrown by MVC later in the pipeline.</span></span> <span data-ttu-id="5f0b7-356">Lorsque vous traitez une exception dans un filtre de résultat, vous n’êtes peut-être pas en mesure d’écrire des données dans la réponse.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-356">When you're handling an exception in a result filter, you might not be able to write any data to the response.</span></span> <span data-ttu-id="5f0b7-357">Si le résultat d’action génère en cours via son exécution, et les en-têtes ont déjà été vidées sur le client, il n’existe aucun mécanisme fiable pour envoyer un code d’échec.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-357">If the action result throws partway through its execution, and the headers have already been flushed to the client, there's no reliable mechanism to send a failure code.</span></span>

<span data-ttu-id="5f0b7-358">Pour un `IAsyncResultFilter` un appel à `await next()` sur la `ResultExecutionDelegate` exécute tous les filtres de résultats suivants et le résultat d’action.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-358">For an `IAsyncResultFilter` a call to `await next()` on the `ResultExecutionDelegate` executes any subsequent result filters and the action result.</span></span> <span data-ttu-id="5f0b7-359">Pour de court-circuit, définissez `ResultExecutingContext.Cancel` à true et n’appelez pas la `ResultExectionDelegate`.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-359">To short-circuit, set `ResultExecutingContext.Cancel` to true and do not call the `ResultExectionDelegate`.</span></span>

<span data-ttu-id="5f0b7-360">Le framework fournit un résumé `ResultFilterAttribute` que vous pouvez créer une sous-classe.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-360">The framework provides an abstract `ResultFilterAttribute` that you can subclass.</span></span> <span data-ttu-id="5f0b7-361">Le [AddHeaderAttribute](#add-header-attribute) classe ci-dessus est un exemple d’un attribut de filtre de résultat.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-361">The [AddHeaderAttribute](#add-header-attribute) class shown earlier is an example of a result filter attribute.</span></span>

## <a name="using-middleware-in-the-filter-pipeline"></a><span data-ttu-id="5f0b7-362">À l’aide d’intergiciel (middleware) dans le pipeline de filtre</span><span class="sxs-lookup"><span data-stu-id="5f0b7-362">Using middleware in the filter pipeline</span></span>

<span data-ttu-id="5f0b7-363">Filtres de ressources fonctionnent comme [intergiciel (middleware)](../../fundamentals/middleware.md) dans la mesure où ils entourent l’exécution de tous les éléments qui est fourni plus loin dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-363">Resource filters work like [middleware](../../fundamentals/middleware.md) in that they surround the execution of everything that comes later in the pipeline.</span></span> <span data-ttu-id="5f0b7-364">Diffèrent des filtres à partir de l’intergiciel (middleware) dans la mesure où ils font partie de MVC, ce qui signifie qu’ils ont accès au contexte MVC et constructions.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-364">But filters differ from middleware in that they are part of MVC, which means that they have access to MVC context and constructs.</span></span>

<span data-ttu-id="5f0b7-365">Dans ASP.NET Core 1.1, vous pouvez utiliser l’intergiciel (middleware) dans le pipeline de filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-365">In ASP.NET Core 1.1, you can use middleware in the filter pipeline.</span></span> <span data-ttu-id="5f0b7-366">Vous pouvez souhaiter faire si vous avez un composant d’intergiciel (middleware) qui doit accéder aux données d’itinéraire MVC ou qui doit s’exécuter que pour certains contrôleurs ou les actions.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-366">You might want to do that if you have a middleware component that needs access to MVC route data, or one that should run only for certain controllers or actions.</span></span>

<span data-ttu-id="5f0b7-367">Pour utiliser l’intergiciel (middleware) en tant que filtre, créez un type avec un `Configure` méthode qui spécifie l’intergiciel (middleware) que vous souhaitez insérer dans le pipeline de filtre.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-367">To use middleware as a filter, create a type with a `Configure` method that specifies the middleware that you want to inject into the filter pipeline.</span></span> <span data-ttu-id="5f0b7-368">Voici un exemple qui utilise l’intergiciel de localisation pour établir la culture actuelle pour une demande :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-368">Here's an example that uses the localization middleware to establish the current culture for a request:</span></span>

<span data-ttu-id="5f0b7-369">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/LocalizationPipeline.cs?name=snippet_MiddlewareFilter&highlight=3,21)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-369">[!code-csharp[Main](./filters/sample/src/FiltersSample/Filters/LocalizationPipeline.cs?name=snippet_MiddlewareFilter&highlight=3,21)]</span></span>

<span data-ttu-id="5f0b7-370">Vous pouvez ensuite utiliser le `MiddlewareFilterAttribute` pour exécuter l’intergiciel (middleware) pour un contrôleur sélectionné ou l’action ou globalement :</span><span class="sxs-lookup"><span data-stu-id="5f0b7-370">You can then use the `MiddlewareFilterAttribute` to run the middleware for a selected controller or action or globally:</span></span>

<span data-ttu-id="5f0b7-371">[!code-csharp[Main](./filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_MiddlewareFilter&highlight=2)]</span><span class="sxs-lookup"><span data-stu-id="5f0b7-371">[!code-csharp[Main](./filters/sample/src/FiltersSample/Controllers/HomeController.cs?name=snippet_MiddlewareFilter&highlight=2)]</span></span>

<span data-ttu-id="5f0b7-372">Filtres d’intergiciel (middleware) s’exécutent à la même étape du pipeline de filtre en tant que ressource filtre, avant la liaison de modèle et après le reste du pipeline.</span><span class="sxs-lookup"><span data-stu-id="5f0b7-372">Middleware filters run at the same stage of the filter pipeline as Resource filters, before model binding and after the rest of the pipeline.</span></span>

## <a name="next-actions"></a><span data-ttu-id="5f0b7-373">Actions suivantes</span><span class="sxs-lookup"><span data-stu-id="5f0b7-373">Next actions</span></span>

<span data-ttu-id="5f0b7-374">À faire des essais avec des filtres [télécharger, tester et modifier l’exemple](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span><span class="sxs-lookup"><span data-stu-id="5f0b7-374">To experiment with filters, [download, test and modify the sample](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/filters/sample).</span></span>
