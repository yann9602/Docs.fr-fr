---
title: "Cœur de ASP.NET MVC avec EF Core - CRUD - 2 de 10"
author: tdykstra
description: 
keywords: "ASP.NET Core, Entity Framework Core, CRUD, créer, lire, mettre à jour, supprimer"
ms.author: tdykstra
manager: wpickett
ms.date: 03/15/2017
ms.topic: get-started-article
ms.assetid: 6e1cd570-40f1-4b24-8b6e-7d2d27758f18
ms.technology: aspnet
ms.prod: asp.net-core
uid: data/ef-mvc/crud
ms.openlocfilehash: b99a58d77d4f1751753ae576ade4bd6dd981fbbf
ms.sourcegitcommit: bd05f7ea8f87ad076ef6e8b704698ebcba5ca80c
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/25/2017
---
# <a name="create-read-update-and-delete---ef-core-with-aspnet-core-mvc-tutorial-2-of-10"></a><span data-ttu-id="4b96a-103">Créer, lire, mettre à jour et supprimer - Core EF avec le didacticiel d’ASP.NET MVC de base (2 sur 10)</span><span class="sxs-lookup"><span data-stu-id="4b96a-103">Create, Read, Update, and Delete - EF Core with ASP.NET Core MVC tutorial (2 of 10)</span></span>

<span data-ttu-id="4b96a-104">Par [Tom Dykstra](https://github.com/tdykstra) et [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="4b96a-104">By [Tom Dykstra](https://github.com/tdykstra) and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="4b96a-105">L’exemple d’application web Contoso University montre comment créer des applications web ASP.NET MVC de base à l’aide d’Entity Framework Core et Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="4b96a-105">The Contoso University sample web application demonstrates how to create ASP.NET Core MVC web applications using Entity Framework Core and Visual Studio.</span></span> <span data-ttu-id="4b96a-106">Pour plus d’informations sur la série de didacticiels, consultez [le premier didacticiel de la série](intro.md).</span><span class="sxs-lookup"><span data-stu-id="4b96a-106">For information about the tutorial series, see [the first tutorial in the series](intro.md).</span></span>

<span data-ttu-id="4b96a-107">Dans le didacticiel précédent, vous avez créé une application MVC qui stocke et affiche les données à l’aide d’Entity Framework et SQL Server LocalDB.</span><span class="sxs-lookup"><span data-stu-id="4b96a-107">In the previous tutorial, you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="4b96a-108">Dans ce didacticiel, vous allez examiner et personnaliser le CRUD (créer, lire, mettre à jour, supprimer) le code que la génération de modèles automatique MVC crée automatiquement pour vous dans les contrôleurs et vues.</span><span class="sxs-lookup"><span data-stu-id="4b96a-108">In this tutorial, you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE] 
> <span data-ttu-id="4b96a-109">Il est courant de mettre en œuvre le modèle de référentiel afin de créer une couche d’abstraction entre votre contrôleur et de la couche d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-109">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="4b96a-110">Pour conserver ces didacticiels simple et consiste à apprendre à utiliser Entity Framework proprement dit, ils n’utilisent pas les référentiels.</span><span class="sxs-lookup"><span data-stu-id="4b96a-110">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="4b96a-111">Pour plus d’informations sur les référentiels avec EF, consultez [le dernier didacticiel de cette série](advanced.md).</span><span class="sxs-lookup"><span data-stu-id="4b96a-111">For information about repositories with EF, see [the last tutorial in this series](advanced.md).</span></span>

<span data-ttu-id="4b96a-112">Dans ce didacticiel, vous devez utiliser les pages web suivantes :</span><span class="sxs-lookup"><span data-stu-id="4b96a-112">In this tutorial, you'll work with the following web pages:</span></span>

![Page de détails de l’étudiant](crud/_static/student-details.png)

![Page de création d’étudiant](crud/_static/student-create.png)

![Page Modifier l’étudiant](crud/_static/student-edit.png)

![Supprimer la page étudiant](crud/_static/student-delete.png)

## <a name="customize-the-details-page"></a><span data-ttu-id="4b96a-117">Personnaliser la page de détails</span><span class="sxs-lookup"><span data-stu-id="4b96a-117">Customize the Details page</span></span>

<span data-ttu-id="4b96a-118">Le code de modèle généré automatiquement pour la page d’Index des étudiants omis le `Enrollments` propriété, car cette propriété contienne une collection.</span><span class="sxs-lookup"><span data-stu-id="4b96a-118">The scaffolded code for the Students Index page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="4b96a-119">Dans le **détails** page, vous devez afficher le contenu de la collection dans un tableau HTML.</span><span class="sxs-lookup"><span data-stu-id="4b96a-119">In the **Details** page you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="4b96a-120">Dans *Controllers/StudentsController.cs*, la méthode d’action pour les détails de l’afficher utilise le `SingleOrDefaultAsync` méthode pour récupérer un seul `Student` entité.</span><span class="sxs-lookup"><span data-stu-id="4b96a-120">In *Controllers/StudentsController.cs*, the action method for the Details view uses the `SingleOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="4b96a-121">Ajoutez le code qui appelle `Include`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-121">Add code that calls `Include`.</span></span> <span data-ttu-id="4b96a-122">`ThenInclude`, et `AsNoTracking` méthodes, comme indiqué dans le code en surbrillance suivant.</span><span class="sxs-lookup"><span data-stu-id="4b96a-122">`ThenInclude`,  and `AsNoTracking` methods, as shown in the following highlighted code.</span></span>

<span data-ttu-id="4b96a-123">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]</span><span class="sxs-lookup"><span data-stu-id="4b96a-123">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]</span></span>

<span data-ttu-id="4b96a-124">Le `Include` et `ThenInclude` méthodes provoquent le contexte de chargement le `Student.Enrollments` propriété de navigation et dans chaque inscription le `Enrollment.Course` propriété de navigation.</span><span class="sxs-lookup"><span data-stu-id="4b96a-124">The `Include` and `ThenInclude` methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span>  <span data-ttu-id="4b96a-125">Vous en apprendrez davantage sur ces méthodes dans les [la lecture des données connexes](read-related-data.md) didacticiel.</span><span class="sxs-lookup"><span data-stu-id="4b96a-125">You'll learn more about these methods in the [reading related data](read-related-data.md) tutorial.</span></span>

<span data-ttu-id="4b96a-126">Le `AsNoTracking` méthode améliore les performances dans les scénarios où les entités retournées ne seront pas modifiées dans la durée de vie du contexte actuel.</span><span class="sxs-lookup"><span data-stu-id="4b96a-126">The `AsNoTracking` method improves performance in scenarios where the entities returned will not be updated in the current context's lifetime.</span></span> <span data-ttu-id="4b96a-127">Vous allez en savoir plus sur `AsNoTracking` à la fin de ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="4b96a-127">You'll learn more about `AsNoTracking` at the end of this tutorial.</span></span>

### <a name="route-data"></a><span data-ttu-id="4b96a-128">Données d’itinéraire</span><span class="sxs-lookup"><span data-stu-id="4b96a-128">Route data</span></span>

<span data-ttu-id="4b96a-129">La valeur de clé qui est transmise à la `Details` provient de la méthode *de router les données*.</span><span class="sxs-lookup"><span data-stu-id="4b96a-129">The key value that is passed to the `Details` method comes from *route data*.</span></span> <span data-ttu-id="4b96a-130">Données d’itinéraire sont données le classeur de modèles disponibles dans un segment de l’URL.</span><span class="sxs-lookup"><span data-stu-id="4b96a-130">Route data is data that the model binder found in a segment of the URL.</span></span> <span data-ttu-id="4b96a-131">Par exemple, l’itinéraire par défaut Spécifie les segments de contrôleur, action et id :</span><span class="sxs-lookup"><span data-stu-id="4b96a-131">For example, the default route specifies controller, action, and id segments:</span></span>

<span data-ttu-id="4b96a-132">[!code-csharp[Main](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]</span><span class="sxs-lookup"><span data-stu-id="4b96a-132">[!code-csharp[Main](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]</span></span>

<span data-ttu-id="4b96a-133">Dans l’URL suivante, l’itinéraire par défaut mappe le formateur en tant que le contrôleur, l’Index en tant que l’action et 1 en tant que l’id ; Il s’agit des valeurs de données d’itinéraire.</span><span class="sxs-lookup"><span data-stu-id="4b96a-133">In the following URL, the default route maps Instructor as the controller, Index as the action, and 1 as the id; these are route data values.</span></span>

```
http://localhost:1230/Instructor/Index/1?courseID=2021
```

<span data-ttu-id="4b96a-134">La dernière partie de l’URL (« ? courseID = 2021 ») est une valeur de chaîne de requête.</span><span class="sxs-lookup"><span data-stu-id="4b96a-134">The last part of the URL ("?courseID=2021") is a query string value.</span></span> <span data-ttu-id="4b96a-135">Le classeur de modèles sera également passer la valeur d’ID pour le `Details` méthode `id` paramètre si vous le passez en tant que valeur de chaîne de requête :</span><span class="sxs-lookup"><span data-stu-id="4b96a-135">The model binder will also pass the ID value to the `Details` method `id` parameter if you pass it as a query string value:</span></span>

```
http://localhost:1230/Instructor/Index?id=1&CourseID=2021
```

<span data-ttu-id="4b96a-136">Dans la page d’Index, les URL de liens hypertexte sont créés par les instructions d’assistance de balise dans la vue Razor.</span><span class="sxs-lookup"><span data-stu-id="4b96a-136">In the Index page, hyperlink URLs are created by tag helper statements in the Razor view.</span></span> <span data-ttu-id="4b96a-137">Dans le code Razor suivant, le `id` paramètre correspond à l’itinéraire par défaut, par conséquent, `id` est ajouté pour les données d’itinéraire.</span><span class="sxs-lookup"><span data-stu-id="4b96a-137">In the following Razor code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

```html
<a asp-action="Edit" asp-route-id="@item.ID">Edit</a>
```

<span data-ttu-id="4b96a-138">Cette opération génère le code HTML suivant lorsque `item.ID` est 6 :</span><span class="sxs-lookup"><span data-stu-id="4b96a-138">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit/6">Edit</a>
```

<span data-ttu-id="4b96a-139">Dans le code Razor suivant, `studentID` ne correspond pas à un paramètre dans l’itinéraire par défaut, donc elle est ajoutée en tant qu’une chaîne de requête.</span><span class="sxs-lookup"><span data-stu-id="4b96a-139">In the following Razor code, `studentID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

```html
<a asp-action="Edit" asp-route-studentID="@item.ID">Edit</a>
```

<span data-ttu-id="4b96a-140">Cette opération génère le code HTML suivant lorsque `item.ID` est 6 :</span><span class="sxs-lookup"><span data-stu-id="4b96a-140">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit?studentID=6">Edit</a>
```

<span data-ttu-id="4b96a-141">Pour plus d’informations sur les programmes d’assistance de balise, consultez [programmes d’assistance de balise dans ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span><span class="sxs-lookup"><span data-stu-id="4b96a-141">For more information about tag helpers, see [Tag helpers in ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span></span>

### <a name="add-enrollments-to-the-details-view"></a><span data-ttu-id="4b96a-142">Ajouter des inscriptions à l’affichage des détails</span><span class="sxs-lookup"><span data-stu-id="4b96a-142">Add enrollments to the Details view</span></span>

<span data-ttu-id="4b96a-143">Ouvrez *Views/Students/Details.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="4b96a-143">Open *Views/Students/Details.cshtml*.</span></span> <span data-ttu-id="4b96a-144">Chaque champ est affiché à l’aide de `DisplayNameFor` et `DisplayFor` assistance, comme indiqué dans l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="4b96a-144">Each field is displayed using `DisplayNameFor` and `DisplayFor` helper, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=13-18&highlight=2,5)]

<span data-ttu-id="4b96a-145">Après le dernier champ et immédiatement avant la fermeture `</dl>` , ajoutez le code suivant pour afficher la liste des inscriptions :</span><span class="sxs-lookup"><span data-stu-id="4b96a-145">After the last field and immediately before the closing `</dl>` tag, add the following code to display a list of enrollments:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=31-52)]

<span data-ttu-id="4b96a-146">Si la mise en retrait du code est incorrect, une fois que vous collez le code, appuyez sur CTRL + K + D pour résoudre ce problème.</span><span class="sxs-lookup"><span data-stu-id="4b96a-146">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="4b96a-147">Ce code effectue une itération sur les entités dans le `Enrollments` propriété de navigation.</span><span class="sxs-lookup"><span data-stu-id="4b96a-147">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="4b96a-148">Pour chaque inscription, il affiche le titre du cours et la qualité.</span><span class="sxs-lookup"><span data-stu-id="4b96a-148">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="4b96a-149">Le titre du cours est récupéré à partir de l’entité de cours qui est stockée dans le `Course` propriété de navigation de l’entité d’inscriptions.</span><span class="sxs-lookup"><span data-stu-id="4b96a-149">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="4b96a-150">Exécutez l’application, sélectionnez le **étudiants** onglet, puis cliquez sur le **détails** lien pour un étudiant.</span><span class="sxs-lookup"><span data-stu-id="4b96a-150">Run the application, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="4b96a-151">Vous voyez la liste des cours et les notes pour l’étudiant sélectionné :</span><span class="sxs-lookup"><span data-stu-id="4b96a-151">You see the list of courses and grades for the selected student:</span></span>

![Page de détails de l’étudiant](crud/_static/student-details.png)

## <a name="update-the-create-page"></a><span data-ttu-id="4b96a-153">Mise à jour de la page de création</span><span class="sxs-lookup"><span data-stu-id="4b96a-153">Update the Create page</span></span>

<span data-ttu-id="4b96a-154">Dans *StudentsController.cs*, modifier le HttpPost `Create` méthode en ajoutant un bloc try-catch et en supprimant des ID à partir de la `Bind` attribut.</span><span class="sxs-lookup"><span data-stu-id="4b96a-154">In *StudentsController.cs*, modify the HttpPost `Create` method by adding a try-catch block and removing ID from the `Bind` attribute.</span></span>

<span data-ttu-id="4b96a-155">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]</span><span class="sxs-lookup"><span data-stu-id="4b96a-155">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]</span></span>

<span data-ttu-id="4b96a-156">Ce code ajoute l’entité Student créée par le classeur de modèles ASP.NET MVC à l’entité étudiants défini et puis enregistre les modifications dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-156">This code adds the Student entity created by the ASP.NET MVC model binder to the Students entity set and then saves the changes to the database.</span></span> <span data-ttu-id="4b96a-157">(Classeur de modèles fait référence à la fonctionnalité d’ASP.NET MVC qui rend plus facile de travailler avec les données envoyées par un formulaire, un classeur de modèles convertit les valeurs de formulaire publiées à des types CLR et les transmet à la méthode d’action dans les paramètres.</span><span class="sxs-lookup"><span data-stu-id="4b96a-157">(Model binder refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="4b96a-158">Dans ce cas, le classeur de modèles instancie une entité de l’étudiant pour vous à l’aide des valeurs de propriété de la collection de formulaires.)</span><span class="sxs-lookup"><span data-stu-id="4b96a-158">In this case, the model binder instantiates a Student entity for you using property values from the Form collection.)</span></span>

<span data-ttu-id="4b96a-159">Vous supprimé `ID` à partir de la `Bind` d’attribut, car l’ID est la valeur de clé primaire SQL Server définira automatiquement lorsque la ligne est insérée.</span><span class="sxs-lookup"><span data-stu-id="4b96a-159">You removed `ID` from the `Bind` attribute because ID is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="4b96a-160">Entrée de l’utilisateur ne définit pas la valeur d’ID.</span><span class="sxs-lookup"><span data-stu-id="4b96a-160">Input from the user does not set the ID value.</span></span>

<span data-ttu-id="4b96a-161">Autre que le `Bind` attribut, le bloc try-catch est la seule modification que vous avez apportées au code de modèle généré automatiquement.</span><span class="sxs-lookup"><span data-stu-id="4b96a-161">Other than the `Bind` attribute, the try-catch block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="4b96a-162">Si une exception qui dérive de `DbUpdateException` est interceptée pendant l’enregistrement des modifications, un message d’erreur générique s’affiche.</span><span class="sxs-lookup"><span data-stu-id="4b96a-162">If an exception that derives from `DbUpdateException` is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="4b96a-163">`DbUpdateException`exceptions sont parfois due à un élément externe à l’application plutôt qu’une erreur de programmation, il est conseillé pour réessayer.</span><span class="sxs-lookup"><span data-stu-id="4b96a-163">`DbUpdateException` exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="4b96a-164">Bien que non implémenté dans cet exemple, une application de qualité production se connectera l’exception.</span><span class="sxs-lookup"><span data-stu-id="4b96a-164">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="4b96a-165">Pour plus d’informations, consultez la **journal pour obtenir un aperçu** section [surveillance et télémétrie (construction réelle les applications Cloud avec Azure)](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span><span class="sxs-lookup"><span data-stu-id="4b96a-165">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span></span>

<span data-ttu-id="4b96a-166">Le `ValidateAntiForgeryToken` attribut aide à empêcher les attaques par falsification (CSRF) de demande entre sites.</span><span class="sxs-lookup"><span data-stu-id="4b96a-166">The `ValidateAntiForgeryToken` attribute helps prevent cross-site request forgery (CSRF) attacks.</span></span> <span data-ttu-id="4b96a-167">Le jeton est automatiquement injecté dans la vue par le [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) et est inclus lorsque le formulaire est envoyé par l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="4b96a-167">The token is automatically injected into the view by the [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) and is included when the form is submitted by the user.</span></span> <span data-ttu-id="4b96a-168">Le jeton est validé par le `ValidateAntiForgeryToken` attribut.</span><span class="sxs-lookup"><span data-stu-id="4b96a-168">The token is validated by the `ValidateAntiForgeryToken` attribute.</span></span> <span data-ttu-id="4b96a-169">Pour plus d’informations sur CSRF, consultez [falsification de requête anti](../../security/anti-request-forgery.md).</span><span class="sxs-lookup"><span data-stu-id="4b96a-169">For more information about CSRF, see [Anti-Request Forgery](../../security/anti-request-forgery.md).</span></span>

<a id="overpost"></a>
### <a name="security-note-about-overposting"></a><span data-ttu-id="4b96a-170">Note de sécurité sur overposting</span><span class="sxs-lookup"><span data-stu-id="4b96a-170">Security note about overposting</span></span>

<span data-ttu-id="4b96a-171">Le `Bind` attribut incluant le code de modèle généré automatiquement sur le `Create` méthode consiste à protéger contre overposting de créer des scénarios.</span><span class="sxs-lookup"><span data-stu-id="4b96a-171">The `Bind` attribute that the scaffolded code includes on the `Create` method is one way to protect against overposting in create scenarios.</span></span> <span data-ttu-id="4b96a-172">Par exemple, supposons que l’entité Student inclut un `Secret` propriété que vous ne souhaitez pas cette page web à définir.</span><span class="sxs-lookup"><span data-stu-id="4b96a-172">For example, suppose the Student entity includes a `Secret` property that you don't want this web page to set.</span></span>

```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstMidName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Secret { get; set; }
}
```

<span data-ttu-id="4b96a-173">Même si vous n’avez pas un `Secret` champ sur la page web, un pirate peut utiliser un outil tel que Fiddler ou écrire du JavaScript, pour valider un `Secret` former la valeur.</span><span class="sxs-lookup"><span data-stu-id="4b96a-173">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="4b96a-174">Sans le `Bind` attribut limitant les champs que le classeur de modèles utilise lorsqu’il crée une instance d’étudiant, le classeur de modèles choisit qui `Secret` former la valeur et l’utiliser pour créer l’instance d’entité étudiant.</span><span class="sxs-lookup"><span data-stu-id="4b96a-174">Without the `Bind` attribute limiting the fields that the model binder uses when it creates a Student instance, the model binder would pick up that `Secret` form value and use it to create the Student entity instance.</span></span> <span data-ttu-id="4b96a-175">Ensuite, quel que soit le pirate spécifié pour la valeur du `Secret` champ de formulaire est mis à jour de la base de données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-175">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="4b96a-176">L’illustration suivante montre l’ajout de l’outil de Fiddler le `Secret` champ (avec la valeur « OverPost ») pour les valeurs de formulaire publiées.</span><span class="sxs-lookup"><span data-stu-id="4b96a-176">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Champ de clé secrète d’ajout de Fiddler](crud/_static/fiddler.png)

<span data-ttu-id="4b96a-178">La valeur « OverPost » puis est correctement ajoutée à la `Secret` propriété le texte inséré de ligne, même si vous n’aviez pas envisagés que la page web est en mesure de définir cette propriété.</span><span class="sxs-lookup"><span data-stu-id="4b96a-178">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

<span data-ttu-id="4b96a-179">Vous pouvez empêcher overposting dans les scénarios de modification par la lecture de l’entité à partir de la base de données tout d’abord, puis en appelant `TryUpdateModel`, en passant une liste de propriétés autorisés explicites.</span><span class="sxs-lookup"><span data-stu-id="4b96a-179">You can prevent overposting in edit scenarios by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="4b96a-180">Qui est la méthode utilisée dans ces didacticiels.</span><span class="sxs-lookup"><span data-stu-id="4b96a-180">That is the method used in these tutorials.</span></span>

<span data-ttu-id="4b96a-181">Une autre façon d’empêcher overposting qui est utilisé par de nombreux développeurs consiste à utiliser les afficher les modèles plutôt que des classes d’entité avec la liaison de modèle.</span><span class="sxs-lookup"><span data-stu-id="4b96a-181">An alternative way to prevent overposting that is preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="4b96a-182">Incluez uniquement les propriétés que vous souhaitez mettre à jour dans le modèle d’affichage.</span><span class="sxs-lookup"><span data-stu-id="4b96a-182">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="4b96a-183">Une fois le classeur de modèles MVC terminée, copiez les propriétés de modèle d’affichage pour l’instance d’entité, si vous le souhaitez à l’aide d’un outil tel que AutoMapper.</span><span class="sxs-lookup"><span data-stu-id="4b96a-183">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as AutoMapper.</span></span> <span data-ttu-id="4b96a-184">Utilisez `_context.Entry` sur l’instance d’entité pour définir son état sur `Unchanged`, puis définissez `Property("PropertyName").IsModified` sur true sur chaque propriété d’entité qui est incluse dans le modèle d’affichage.</span><span class="sxs-lookup"><span data-stu-id="4b96a-184">Use `_context.Entry` on the entity instance to set its state to `Unchanged`, and then set `Property("PropertyName").IsModified` to true on each entity property that is included in the view model.</span></span> <span data-ttu-id="4b96a-185">Cette méthode est effective à la fois dans modifier et créer des scénarios.</span><span class="sxs-lookup"><span data-stu-id="4b96a-185">This method works in both edit and create scenarios.</span></span>

### <a name="test-the-create-page"></a><span data-ttu-id="4b96a-186">La page de création de test</span><span class="sxs-lookup"><span data-stu-id="4b96a-186">Test the Create page</span></span>

<span data-ttu-id="4b96a-187">Le code dans *Views/Students/Create.cshtml* utilise `label`, `input`, et `span` (pour les messages de validation) programmes d’assistance pour chaque champ de balise.</span><span class="sxs-lookup"><span data-stu-id="4b96a-187">The code in *Views/Students/Create.cshtml* uses `label`, `input`, and `span` (for validation messages) tag helpers for each field.</span></span>

<span data-ttu-id="4b96a-188">Exécutez la page en sélectionnant le **étudiants** onglet et en cliquant sur **créer un nouveau**.</span><span class="sxs-lookup"><span data-stu-id="4b96a-188">Run the page by selecting the **Students** tab and clicking **Create New**.</span></span>

<span data-ttu-id="4b96a-189">Entrez les noms et une date.</span><span class="sxs-lookup"><span data-stu-id="4b96a-189">Enter names and a date.</span></span> <span data-ttu-id="4b96a-190">Essayez d’entrer une date non valide si votre navigateur vous permet de le faire.</span><span class="sxs-lookup"><span data-stu-id="4b96a-190">Try entering an invalid date if your browser lets you do that.</span></span> <span data-ttu-id="4b96a-191">(Certains navigateurs qui vous oblige à utiliser un sélecteur de dates.) Puis cliquez sur **créer** pour afficher le message d’erreur.</span><span class="sxs-lookup"><span data-stu-id="4b96a-191">(Some browsers force you to use a date picker.) Then click **Create** to see the error message.</span></span>

![Erreur de validation de date](crud/_static/date-error.png)

<span data-ttu-id="4b96a-193">Il s’agit de la validation côté serveur que vous obtenez par défaut ; dans un prochain didacticiel, vous verrez comment ajouter des attributs qui génèrent également du code pour la validation côté client.</span><span class="sxs-lookup"><span data-stu-id="4b96a-193">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="4b96a-194">Le code en surbrillance suivant illustre la vérification de validation de modèle dans le `Create` (méthode).</span><span class="sxs-lookup"><span data-stu-id="4b96a-194">The following highlighted code shows the model validation check in the `Create` method.</span></span>

<span data-ttu-id="4b96a-195">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]</span><span class="sxs-lookup"><span data-stu-id="4b96a-195">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]</span></span>

<span data-ttu-id="4b96a-196">Modifier la date à une valeur valide, puis cliquez sur **créer** pour afficher le nouvel étudiant s’affichent dans le **Index** page.</span><span class="sxs-lookup"><span data-stu-id="4b96a-196">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="4b96a-197">Mise à jour de la page de modification</span><span class="sxs-lookup"><span data-stu-id="4b96a-197">Update the Edit page</span></span>

<span data-ttu-id="4b96a-198">Dans *StudentController.cs*, le HttpGet `Edit` (méthode) (l’autre sans le `HttpPost` attribut) utilise le `SingleOrDefaultAsync` méthode pour récupérer l’entité sélectionnée de l’étudiant, comme vous l’avez vu dans la `Details` (méthode).</span><span class="sxs-lookup"><span data-stu-id="4b96a-198">In *StudentController.cs*, the HttpGet `Edit` method (the one without the `HttpPost` attribute) uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="4b96a-199">Vous n’avez pas besoin de modifier cette méthode.</span><span class="sxs-lookup"><span data-stu-id="4b96a-199">You don't need to change this method.</span></span>

### <a name="recommended-httppost-edit-code-read-and-update"></a><span data-ttu-id="4b96a-200">HttpPost Modifier code recommandé : lecture et mise à jour</span><span class="sxs-lookup"><span data-stu-id="4b96a-200">Recommended HttpPost Edit code: Read and update</span></span>

<span data-ttu-id="4b96a-201">Remplacez la méthode d’action HttpPost modifier avec le code suivant.</span><span class="sxs-lookup"><span data-stu-id="4b96a-201">Replace the HttpPost Edit action method with the following code.</span></span>

<span data-ttu-id="4b96a-202">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]</span><span class="sxs-lookup"><span data-stu-id="4b96a-202">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]</span></span>

<span data-ttu-id="4b96a-203">Ces modifications implémentent une meilleure pratique de sécurité pour empêcher overposting.</span><span class="sxs-lookup"><span data-stu-id="4b96a-203">These changes implement a security best practice to prevent overposting.</span></span> <span data-ttu-id="4b96a-204">Le scaffolder généré un `Bind` d’attribut et ajouté l’entité créée par le classeur de modèles à l’entité avec une `Modified` indicateur.</span><span class="sxs-lookup"><span data-stu-id="4b96a-204">The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a `Modified` flag.</span></span> <span data-ttu-id="4b96a-205">Que code n’est pas recommandé pour de nombreux scénarios, car le `Bind` attribut efface toutes les données existantes dans les champs non répertoriés dans le `Include` paramètre.</span><span class="sxs-lookup"><span data-stu-id="4b96a-205">That code is not recommended for many scenarios because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span>

<span data-ttu-id="4b96a-206">Le nouveau code lit l’entité existante et les appels `TryUpdateModel` pour mettre à jour les champs dans l’entité récupérée [en fonction de l’entrée d’utilisateur dans les données de formulaire publiées](xref:mvc/models/model-binding#how-model-binding-works).</span><span class="sxs-lookup"><span data-stu-id="4b96a-206">The new code reads the existing entity and calls `TryUpdateModel` to update fields in the retrieved entity [based on user input in the posted form data](xref:mvc/models/model-binding#how-model-binding-works).</span></span> <span data-ttu-id="4b96a-207">Le suivi automatique d’Entity Framework définit le `Modified` indicateur sur les champs qui sont modifiés par l’entrée du formulaire.</span><span class="sxs-lookup"><span data-stu-id="4b96a-207">The Entity Framework's automatic change tracking sets the `Modified` flag on the fields that are changed by form input.</span></span> <span data-ttu-id="4b96a-208">Lorsque le `SaveChanges` est appelée, Entity Framework crée des instructions SQL pour mettre à jour la ligne de base de données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-208">When the `SaveChanges` method is called, the Entity Framework creates SQL statements to update the database row.</span></span> <span data-ttu-id="4b96a-209">Conflits d’accès concurrentiel sont ignorés, et uniquement les colonnes de table qui ont été mis à jour par l’utilisateur sont mises à jour dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-209">Concurrency conflicts are ignored, and only the table columns that were updated by the user are updated in the database.</span></span> <span data-ttu-id="4b96a-210">(Un prochain didacticiel montre comment gérer les conflits d’accès concurrentiel.)</span><span class="sxs-lookup"><span data-stu-id="4b96a-210">(A later tutorial shows how to handle concurrency conflicts.)</span></span>

<span data-ttu-id="4b96a-211">Comme une meilleure pratique pour empêcher sur-validation, les champs que vous souhaitez être mise à jour par le **modifier** page sont autorisés dans le `TryUpdateModel` paramètres.</span><span class="sxs-lookup"><span data-stu-id="4b96a-211">As a best practice to prevent overposting, the fields that you want to be updateable by the **Edit** page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="4b96a-212">(Une chaîne vide avant la liste de champs dans la liste de paramètres est pour un préfixe à utiliser avec les noms de champs de formulaire.) Actuellement il n’y aucun des champs supplémentaires que vous protégez, mais qui répertorie les champs que vous souhaitez le classeur de modèles pour lier garantit que si vous ajoutez les champs pour le modèle de données à l’avenir, s’ils sont automatiquement protégés jusqu'à ce que vous les ajoutez ici.</span><span class="sxs-lookup"><span data-stu-id="4b96a-212">(The empty string preceding the list of fields in the parameter list is for a prefix to use with the form fields names.) Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="4b96a-213">À la suite de ces modifications, la signature de méthode de HttpPost `Edit` méthode est le même que le HttpGet `Edit` méthode ; par conséquent, vous avez renommé la méthode `EditPost`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-213">As a result of these changes, the method signature of the HttpPost `Edit` method is the same as the HttpGet `Edit` method; therefore you've renamed the method `EditPost`.</span></span>

### <a name="alternative-httppost-edit-code-create-and-attach"></a><span data-ttu-id="4b96a-214">Code de substitution HttpPost modifier : créer et attacher</span><span class="sxs-lookup"><span data-stu-id="4b96a-214">Alternative HttpPost Edit code: Create and attach</span></span>

<span data-ttu-id="4b96a-215">Du code de modification HttpPost recommandé garantit que seules les colonnes modifiées mis à jour et conserve les données dans les propriétés que vous ne souhaitez incluses pour la liaison de modèle.</span><span class="sxs-lookup"><span data-stu-id="4b96a-215">The recommended HttpPost edit code ensures that only changed columns get updated and preserves data in properties that you don't want included for model binding.</span></span> <span data-ttu-id="4b96a-216">Toutefois, l’approche en lecture requiert une base de données supplémentaire en lecture et peut entraîner un code plus complexe pour la gestion des conflits d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="4b96a-216">However, the read-first approach requires an extra database read, and can result in more complex code for handling concurrency conflicts.</span></span> <span data-ttu-id="4b96a-217">Une alternative consiste à attacher une entité créée par le classeur de modèles dans le contexte EF et la marquer comme étant modifiée.</span><span class="sxs-lookup"><span data-stu-id="4b96a-217">An alternative is to attach an entity created by the model binder to the EF context and mark it as modified.</span></span> <span data-ttu-id="4b96a-218">(Ne mettez pas à jour votre projet avec ce code, elle a affichée uniquement à illustrer une approche facultatif.)</span><span class="sxs-lookup"><span data-stu-id="4b96a-218">(Don't update your project with this code, it's only shown to illustrate an optional approach.)</span></span> 

<span data-ttu-id="4b96a-219">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]</span><span class="sxs-lookup"><span data-stu-id="4b96a-219">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]</span></span>

<span data-ttu-id="4b96a-220">Vous pouvez utiliser cette approche lorsque l’interface utilisateur de la page web inclut tous les champs dans l’entité et peut mettre à jour un d'entre eux.</span><span class="sxs-lookup"><span data-stu-id="4b96a-220">You can use this approach when the web page UI includes all of the fields in the entity and can update any of them.</span></span>

<span data-ttu-id="4b96a-221">Le code de modèle généré automatiquement utilise l’approche de créer et d’attachement, mais il intercepte uniquement `DbUpdateConcurrencyException` exceptions et retourne des codes d’erreur 404.</span><span class="sxs-lookup"><span data-stu-id="4b96a-221">The scaffolded code uses the create-and-attach approach but only catches `DbUpdateConcurrencyException` exceptions and returns 404 error codes.</span></span>  <span data-ttu-id="4b96a-222">L’exemple suivant intercepte toute exception de mise à jour de base de données et affiche un message d’erreur.</span><span class="sxs-lookup"><span data-stu-id="4b96a-222">The example shown catches any database update exception and displays an error message.</span></span>

### <a name="entity-states"></a><span data-ttu-id="4b96a-223">États de l’entité</span><span class="sxs-lookup"><span data-stu-id="4b96a-223">Entity States</span></span>

<span data-ttu-id="4b96a-224">Le contexte de base de données effectue le suivi des entités en mémoire sont synchronisées avec les lignes correspondantes dans la base de données, et ces informations déterminent ce qui se passe lorsque vous appelez le `SaveChanges` (méthode).</span><span class="sxs-lookup"><span data-stu-id="4b96a-224">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="4b96a-225">Par exemple, lorsque vous passez une nouvelle entité à la `Add` (méthode), que l’état de l’entité est défini sur `Added`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-225">For example, when you pass a new entity to the `Add` method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="4b96a-226">Lorsque vous appelez le `SaveChanges` (méthode), le contexte de base de données émet une commande SQL INSERT.</span><span class="sxs-lookup"><span data-stu-id="4b96a-226">Then when you call the `SaveChanges` method, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="4b96a-227">Une entité peut être l’un des états suivants :</span><span class="sxs-lookup"><span data-stu-id="4b96a-227">An entity may be in one of the following states:</span></span>

* <span data-ttu-id="4b96a-228">`Added`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-228">`Added`.</span></span> <span data-ttu-id="4b96a-229">L’entité n’existe pas encore dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-229">The entity does not yet exist in the database.</span></span> <span data-ttu-id="4b96a-230">Le `SaveChanges` méthode émet une instruction INSERT.</span><span class="sxs-lookup"><span data-stu-id="4b96a-230">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="4b96a-231">`Unchanged`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-231">`Unchanged`.</span></span> <span data-ttu-id="4b96a-232">Rien ne doit être effectué avec cette entité par le `SaveChanges` (méthode).</span><span class="sxs-lookup"><span data-stu-id="4b96a-232">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="4b96a-233">Lorsque vous lisez une entité à partir de la base de données, l’entité démarre avec cet état.</span><span class="sxs-lookup"><span data-stu-id="4b96a-233">When you read an entity from the database, the entity starts out with this status.</span></span>

* <span data-ttu-id="4b96a-234">`Modified`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-234">`Modified`.</span></span> <span data-ttu-id="4b96a-235">Tout ou partie des valeurs de propriété de l’entité ont été modifiés.</span><span class="sxs-lookup"><span data-stu-id="4b96a-235">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="4b96a-236">Le `SaveChanges` méthode émet une instruction de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="4b96a-236">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="4b96a-237">`Deleted`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-237">`Deleted`.</span></span> <span data-ttu-id="4b96a-238">L’entité a été marquée pour suppression.</span><span class="sxs-lookup"><span data-stu-id="4b96a-238">The entity has been marked for deletion.</span></span> <span data-ttu-id="4b96a-239">Le `SaveChanges` méthode émet une instruction DELETE.</span><span class="sxs-lookup"><span data-stu-id="4b96a-239">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="4b96a-240">`Detached`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-240">`Detached`.</span></span> <span data-ttu-id="4b96a-241">L’entité n’est pas suivie par le contexte de base de données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-241">The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="4b96a-242">Dans une application de bureau, les modifications d’état sont généralement définies automatiquement.</span><span class="sxs-lookup"><span data-stu-id="4b96a-242">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="4b96a-243">Lire une entité et apporter des modifications à certaines de ses valeurs de propriété.</span><span class="sxs-lookup"><span data-stu-id="4b96a-243">You read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="4b96a-244">Cela entraîne son état d’entité qui sera automatiquement remplacée par `Modified`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-244">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="4b96a-245">Lorsque vous appelez `SaveChanges`, Entity Framework génère une instruction SQL UPDATE qui met à jour uniquement les propriétés que vous avez modifiée.</span><span class="sxs-lookup"><span data-stu-id="4b96a-245">Then when you call `SaveChanges`, the Entity Framework generates a SQL UPDATE statement that updates only the actual properties that you changed.</span></span>

<span data-ttu-id="4b96a-246">Dans une application web, le `DbContext` qui lit initialement une entité et affiche ses données à être modifié sont supprimées après le rendu d’une page.</span><span class="sxs-lookup"><span data-stu-id="4b96a-246">In a web app, the `DbContext` that initially reads an entity and displays its data to be edited is disposed after a page is rendered.</span></span> <span data-ttu-id="4b96a-247">Lorsque le HttpPost `Edit` méthode d’action est appelée, une nouvelle requête web est lancée, et vous disposez d’une nouvelle instance de la `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-247">When the HttpPost `Edit` action method is called,  a new web request is made and you have a new instance of the `DbContext`.</span></span> <span data-ttu-id="4b96a-248">Si vous ré-Lisez l’entité dans ce nouveau contexte, vous simulez le traitement de bureau.</span><span class="sxs-lookup"><span data-stu-id="4b96a-248">If you re-read the entity in that new context, you simulate desktop processing.</span></span>

<span data-ttu-id="4b96a-249">Mais si vous ne voulez extra opération de lecture, vous devez utiliser l’objet d’entité créé par le classeur de modèles.</span><span class="sxs-lookup"><span data-stu-id="4b96a-249">But if you don't want to do the extra read operation, you have to use the entity object created by the model binder.</span></span>  <span data-ttu-id="4b96a-250">Le plus simple consiste à définir l’état d’entité Modified comme dans l’autre code HttpPost modifier illustré précédemment.</span><span class="sxs-lookup"><span data-stu-id="4b96a-250">The simplest way to do this is to set the entity state to Modified as is done in the alternative HttpPost Edit code shown earlier.</span></span> <span data-ttu-id="4b96a-251">Lorsque vous appelez `SaveChanges`, Entity Framework met à jour toutes les colonnes de la ligne de base de données, car le contexte n’a aucun moyen de savoir quelles propriétés que vous avez modifié.</span><span class="sxs-lookup"><span data-stu-id="4b96a-251">Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>

<span data-ttu-id="4b96a-252">Si vous souhaitez éviter l’approche de lecture en premier, mais vous souhaitez également que l’instruction SQL UPDATE pour mettre à jour uniquement les champs que l’utilisateur a réellement changé, le code est plus complexe.</span><span class="sxs-lookup"><span data-stu-id="4b96a-252">If you want to avoid the read-first approach, but you also want the SQL UPDATE statement to update only the fields that the user actually changed, the code is more complex.</span></span> <span data-ttu-id="4b96a-253">Vous devez enregistrer les valeurs d’origine d’une certaine façon (par exemple à l’aide de champs masqués) afin qu’ils soient disponibles lorsque HttpPost `Edit` méthode est appelée.</span><span class="sxs-lookup"><span data-stu-id="4b96a-253">You have to save the original values in some way (such as by using hidden fields) so that they are available when the HttpPost `Edit` method is called.</span></span> <span data-ttu-id="4b96a-254">Vous pouvez ensuite créer une entité d’étudiants en utilisant les valeurs d’origine, l’appel du `Attach` méthode avec cette version d’origine de l’entité, mettre à jour les valeurs de l’entité pour les nouvelles valeurs, puis appelez `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-254">Then you can create a Student entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges`.</span></span>

### <a name="test-the-edit-page"></a><span data-ttu-id="4b96a-255">Test de la page de modification</span><span class="sxs-lookup"><span data-stu-id="4b96a-255">Test the Edit page</span></span>

<span data-ttu-id="4b96a-256">Exécutez l’application et sélectionnez le **étudiants** onglet, puis cliquez sur une **modifier** lien hypertexte.</span><span class="sxs-lookup"><span data-stu-id="4b96a-256">Run the application and select the **Students** tab, then click an **Edit** hyperlink.</span></span>

![Page Modifier les étudiants](crud/_static/student-edit.png)

<span data-ttu-id="4b96a-258">Modifier une partie des données et cliquez sur **enregistrer**.</span><span class="sxs-lookup"><span data-stu-id="4b96a-258">Change some of the data and click **Save**.</span></span> <span data-ttu-id="4b96a-259">Le **Index** page s’ouvre et affiche les données modifiées.</span><span class="sxs-lookup"><span data-stu-id="4b96a-259">The **Index** page opens and you see the changed data.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="4b96a-260">Mise à jour de la page de suppression</span><span class="sxs-lookup"><span data-stu-id="4b96a-260">Update the Delete page</span></span>

<span data-ttu-id="4b96a-261">Dans *StudentController.cs*, le code du modèle pour le HttpGet `Delete` utilise le `SingleOrDefaultAsync` pour récupérer l’entité sélectionnée de l’étudiant, comme vous l’avez vu dans les détails et modifier les méthodes.</span><span class="sxs-lookup"><span data-stu-id="4b96a-261">In *StudentController.cs*, the template code for the HttpGet `Delete` method uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the Details and Edit methods.</span></span> <span data-ttu-id="4b96a-262">Toutefois, pour implémenter une erreur personnalisée message lorsque l’appel à `SaveChanges` échoue, vous allez ajouter des fonctionnalités à cette méthode et sa vue correspondante.</span><span class="sxs-lookup"><span data-stu-id="4b96a-262">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="4b96a-263">Comme vous avez vu pour la mise à jour et créez des opérations, opérations de suppression nécessitent deux méthodes d’action.</span><span class="sxs-lookup"><span data-stu-id="4b96a-263">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="4b96a-264">La méthode est appelée en réponse à une demande GET affiche une vue qui permet à l’utilisateur à approuver ou d’annuler l’opération de suppression.</span><span class="sxs-lookup"><span data-stu-id="4b96a-264">The method that is called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="4b96a-265">Si l’utilisateur approuve le projet, une demande POST est créée.</span><span class="sxs-lookup"><span data-stu-id="4b96a-265">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="4b96a-266">Lorsque cela se produit, HttpPost `Delete` méthode est appelée et que cette méthode effectue ensuite l’opération de suppression.</span><span class="sxs-lookup"><span data-stu-id="4b96a-266">When that happens, the HttpPost `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="4b96a-267">Vous allez ajouter un bloc try-catch à HttpPost `Delete` méthode pour gérer les erreurs qui peuvent se produire lorsque la base de données est mise à jour.</span><span class="sxs-lookup"><span data-stu-id="4b96a-267">You'll add a try-catch block to the HttpPost `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="4b96a-268">Si une erreur se produit, la méthode HttpPost Delete appelle la méthode de suppression de HttpGet, en lui passant un paramètre qui indique qu’une erreur s’est produite.</span><span class="sxs-lookup"><span data-stu-id="4b96a-268">If an error occurs, the HttpPost Delete method calls the HttpGet Delete method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="4b96a-269">La méthode de suppression de HttpGet réaffiche puis la page de confirmation, ainsi que le message d’erreur, l’utilisateur donner la possibilité d’annuler ou recommencez l’opération.</span><span class="sxs-lookup"><span data-stu-id="4b96a-269">The HttpGet Delete method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

<span data-ttu-id="4b96a-270">Remplacez le HttpGet `Delete` méthode d’action avec le code suivant, qui gère le rapport d’erreurs.</span><span class="sxs-lookup"><span data-stu-id="4b96a-270">Replace the HttpGet `Delete` action method with the following code, which manages error reporting.</span></span>

<span data-ttu-id="4b96a-271">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]</span><span class="sxs-lookup"><span data-stu-id="4b96a-271">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]</span></span>

<span data-ttu-id="4b96a-272">Ce code accepte un paramètre facultatif qui indique si la méthode a été appelée après une défaillance pour enregistrer les modifications.</span><span class="sxs-lookup"><span data-stu-id="4b96a-272">This code accepts an optional parameter that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="4b96a-273">Ce paramètre a la valeur false lorsque la HttpGet `Delete` méthode est appelée sans un échec.</span><span class="sxs-lookup"><span data-stu-id="4b96a-273">This parameter is false when the HttpGet `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="4b96a-274">Lorsqu’elle est appelée par le HttpPost `Delete` méthode en réponse à une erreur de mise à jour de base de données, le paramètre a la valeur true et un message d’erreur est passé à la vue.</span><span class="sxs-lookup"><span data-stu-id="4b96a-274">When it is called by the HttpPost `Delete` method in response to a database update error, the parameter is true and an error message is passed to the view.</span></span>

### <a name="the-read-first-approach-to-httppost-delete"></a><span data-ttu-id="4b96a-275">L’approche de lecture en premier HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="4b96a-275">The read-first approach to HttpPost Delete</span></span>

<span data-ttu-id="4b96a-276">Remplacez le HttpPost `Delete` méthode d’action (nommé `DeleteConfirmed`) avec le code suivant, qui effectue l’opération de suppression et intercepte les erreurs de mise à jour de base de données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-276">Replace the HttpPost `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

<span data-ttu-id="4b96a-277">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6,8-11,13-14,18-23)]</span><span class="sxs-lookup"><span data-stu-id="4b96a-277">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6,8-11,13-14,18-23)]</span></span>

<span data-ttu-id="4b96a-278">Ce code récupère l’entité sélectionnée, puis appelle la `Remove` pour définir l’état de l’entité `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-278">This code retrieves the selected entity, then calls the `Remove` method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="4b96a-279">Lorsque `SaveChanges` est appelée, une suppression SQL commande est générée.</span><span class="sxs-lookup"><span data-stu-id="4b96a-279">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span>

### <a name="the-create-and-attach-approach-to-httppost-delete"></a><span data-ttu-id="4b96a-280">L’approche de créer et d’attachement HttpPost Delete</span><span class="sxs-lookup"><span data-stu-id="4b96a-280">The create-and-attach approach to HttpPost Delete</span></span>

<span data-ttu-id="4b96a-281">Si l’amélioration des performances dans une application de volume élevé est une priorité, vous pouvez éviter une requête SQL inutile en instanciant une entité Student uniquement sur le serveur principal à l’aide de la clé de valeur, puis en définissant l’état d’entité `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="4b96a-281">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query by instantiating a Student entity using only the primary key value and then setting the entity state to `Deleted`.</span></span> <span data-ttu-id="4b96a-282">C’est tout ce qui a besoin d’Entity Framework afin de supprimer l’entité.</span><span class="sxs-lookup"><span data-stu-id="4b96a-282">That's all that the Entity Framework needs in order to delete the entity.</span></span> <span data-ttu-id="4b96a-283">(Ne placez pas de ce code dans votre projet ; il est ici uniquement à illustrer une alternative).</span><span class="sxs-lookup"><span data-stu-id="4b96a-283">(Don't put this code in your project; it's here just to illustrate an alternative.)</span></span>

<span data-ttu-id="4b96a-284">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]</span><span class="sxs-lookup"><span data-stu-id="4b96a-284">[!code-csharp[Main](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]</span></span>

<span data-ttu-id="4b96a-285">Si les données doivent également être supprimées sont liées à l’entité, assurez-vous que cette suppression en cascade est configurée dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-285">If the entity has related data that should also be deleted, make sure that cascade delete is configured in the database.</span></span> <span data-ttu-id="4b96a-286">Avec cette approche pour la suppression de l’entité, EF peut-être ignorer il existe des entités associées à supprimer.</span><span class="sxs-lookup"><span data-stu-id="4b96a-286">With this approach to entity deletion, EF might not realize there are related entities to be deleted.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="4b96a-287">Mettre à jour la vue Delete</span><span class="sxs-lookup"><span data-stu-id="4b96a-287">Update the Delete view</span></span>

<span data-ttu-id="4b96a-288">Dans *Views/Student/Delete.cshtml*, ajouter un message d’erreur entre l’en-tête h2 et l’en-tête h3, comme indiqué dans l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="4b96a-288">In *Views/Student/Delete.cshtml*, add an error message between the h2 heading and the h3 heading, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Delete.cshtml?range=7-9&highlight=2)]

<span data-ttu-id="4b96a-289">Exécutez la page en sélectionnant le **étudiants** onglet et en cliquant sur un **supprimer** lien hypertexte :</span><span class="sxs-lookup"><span data-stu-id="4b96a-289">Run the page by selecting the **Students** tab and clicking a **Delete** hyperlink:</span></span>

![Page Confirmer la suppression](crud/_static/student-delete.png)

<span data-ttu-id="4b96a-291">Cliquez sur **supprimer**.</span><span class="sxs-lookup"><span data-stu-id="4b96a-291">Click **Delete**.</span></span> <span data-ttu-id="4b96a-292">La page d’Index s’affiche sans l’étudiant supprimé.</span><span class="sxs-lookup"><span data-stu-id="4b96a-292">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="4b96a-293">(Vous verrez un exemple de l’erreur de la gestion du code dans l’action dans le didacticiel d’accès concurrentiel).</span><span class="sxs-lookup"><span data-stu-id="4b96a-293">(You'll see an example of the error handling code in action in the concurrency tutorial.)</span></span>

## <a name="closing-database-connections"></a><span data-ttu-id="4b96a-294">Fermeture des connexions de base de données</span><span class="sxs-lookup"><span data-stu-id="4b96a-294">Closing database connections</span></span>

<span data-ttu-id="4b96a-295">Pour libérer les ressources contenant une connexion de base de données, l’instance de contexte doit être supprimée dès que possible lorsque vous avez terminé avec lui.</span><span class="sxs-lookup"><span data-stu-id="4b96a-295">To free up the resources that a database connection holds, the context instance must be disposed as soon as possible when you are done with it.</span></span> <span data-ttu-id="4b96a-296">La fonction intégrée ASP.NET Core [injection de dépendance](../../fundamentals/dependency-injection.md) prend en charge de cette tâche pour vous.</span><span class="sxs-lookup"><span data-stu-id="4b96a-296">The ASP.NET Core built-in [dependency injection](../../fundamentals/dependency-injection.md) takes care of that task for you.</span></span>

<span data-ttu-id="4b96a-297">Dans *Startup.cs* vous appelez le [méthode d’extension AddDbContext](https://github.com/aspnet/EntityFramework/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) à configurer la `DbContext` classe dans le conteneur DI d’ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="4b96a-297">In *Startup.cs* you call the [AddDbContext extension method](https://github.com/aspnet/EntityFramework/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) to provision the `DbContext` class in the ASP.NET DI container.</span></span> <span data-ttu-id="4b96a-298">Que méthode définit la durée de vie du service `Scoped` par défaut.</span><span class="sxs-lookup"><span data-stu-id="4b96a-298">That method sets the service lifetime to `Scoped` by default.</span></span> <span data-ttu-id="4b96a-299">`Scoped`signifie que la durée de vie contexte coïncide avec la durée de vie de demande web, et le `Dispose` méthode sera appelée automatiquement à la fin de la demande web.</span><span class="sxs-lookup"><span data-stu-id="4b96a-299">`Scoped` means the context object lifetime coincides with the web request life time, and the `Dispose` method will be called automatically at the end of the web request.</span></span>

## <a name="handling-transactions"></a><span data-ttu-id="4b96a-300">La gestion des Transactions</span><span class="sxs-lookup"><span data-stu-id="4b96a-300">Handling Transactions</span></span>

<span data-ttu-id="4b96a-301">Entity Framework implémente implicitement des transactions par défaut.</span><span class="sxs-lookup"><span data-stu-id="4b96a-301">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="4b96a-302">Dans les scénarios où vous apportez des modifications à plusieurs lignes ou les tables, puis appelez `SaveChanges`, Entity Framework automatiquement permet de s’assurer que toutes vos modifications réussissent ou qu’elles échouent.</span><span class="sxs-lookup"><span data-stu-id="4b96a-302">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or they all fail.</span></span> <span data-ttu-id="4b96a-303">Si des modifications sont tout d’abord faites ensuite une erreur se produit, ces modifications sont automatiquement restaurées.</span><span class="sxs-lookup"><span data-stu-id="4b96a-303">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="4b96a-304">Pour les scénarios où vous avez besoin de plus contrôler--par exemple, si vous souhaitez inclure des opérations effectuées en dehors d’Entity Framework dans une transaction, consultez [Transactions](https://docs.microsoft.com/ef/core/saving/transactions).</span><span class="sxs-lookup"><span data-stu-id="4b96a-304">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Transactions](https://docs.microsoft.com/ef/core/saving/transactions).</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="4b96a-305">Aucun suivi des requêtes</span><span class="sxs-lookup"><span data-stu-id="4b96a-305">No-tracking queries</span></span>

<span data-ttu-id="4b96a-306">Lorsqu’un contexte de base de données récupère les lignes de la table et crée des objets d’entité qui représentent les, par défaut il effectue le suivi de si les entités en mémoire sont synchronisées avec ce qui figure dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="4b96a-306">When a database context retrieves table rows and creates entity objects that represent them, by default it keeps track of whether the entities in memory are in sync with what's in the database.</span></span> <span data-ttu-id="4b96a-307">Les données en mémoire agit comme un cache et sont utilisées lorsque vous mettez à jour une entité.</span><span class="sxs-lookup"><span data-stu-id="4b96a-307">The data in memory acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="4b96a-308">Cette mise en cache est souvent inutile dans une application web, car les instances de contexte sont généralement de courte durée (une nouvelle est créé et supprimé pour chaque demande) et le contexte qui lit une entité est généralement supprimée avant que cette entité est utilisée à nouveau.</span><span class="sxs-lookup"><span data-stu-id="4b96a-308">This caching is often unnecessary in a web application because context instances are typically short-lived (a new one is created and disposed for each request) and the context that reads an entity is typically disposed before that entity is used again.</span></span>

<span data-ttu-id="4b96a-309">Vous pouvez désactiver le suivi des objets d’entité dans la mémoire en appelant le `AsNoTracking` (méthode).</span><span class="sxs-lookup"><span data-stu-id="4b96a-309">You can disable tracking of entity objects in memory by calling the `AsNoTracking` method.</span></span> <span data-ttu-id="4b96a-310">Scénarios classiques dans lesquels vous souhaiterez faire qui sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="4b96a-310">Typical scenarios in which you might want to do that include the following:</span></span>

* <span data-ttu-id="4b96a-311">Pendant la durée de vie de contexte vous n’avez pas besoin de mettre à jour toutes les entités, et vous n’avez pas besoin d’EF à [charger automatiquement les propriétés de navigation avec les entités récupérées par des requêtes distinctes](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="4b96a-311">During the context lifetime you don't need to update any entities, and you don't need EF to [automatically load navigation properties with  entities retrieved by separate queries](read-related-data.md).</span></span> <span data-ttu-id="4b96a-312">Souvent, ces conditions sont remplies dans les méthodes d’action d’un contrôleur HttpGet.</span><span class="sxs-lookup"><span data-stu-id="4b96a-312">Frequently these conditions are met in a controller's HttpGet action methods.</span></span>

* <span data-ttu-id="4b96a-313">Vous exécutez une requête qui Récupère un gros volume de données, et qu’une petite partie des données retournées est mises à jour.</span><span class="sxs-lookup"><span data-stu-id="4b96a-313">You are running a query that retrieves a large volume of data, and only a small portion of the returned data will be updated.</span></span> <span data-ttu-id="4b96a-314">Il peut être plus efficace de désactiver le suivi de la requête de grande taille et exécuter une requête plus tard de quelques entités qui doivent être mis à jour.</span><span class="sxs-lookup"><span data-stu-id="4b96a-314">It may be more efficient to turn off tracking for the large query, and run a query later for the few entities that need to be updated.</span></span>

* <span data-ttu-id="4b96a-315">Vous souhaitez attacher une entité afin de mettre à jour, mais plus haut que vous avez récupéré la même entité à des fins différentes.</span><span class="sxs-lookup"><span data-stu-id="4b96a-315">You want to attach an entity in order to update it, but earlier you retrieved the same entity for a different purpose.</span></span> <span data-ttu-id="4b96a-316">Étant donné que l’entité est déjà suivie par le contexte de base de données, vous ne peut pas joindre l’entité que vous souhaitez modifier.</span><span class="sxs-lookup"><span data-stu-id="4b96a-316">Because the entity is already being tracked by the database context, you can't attach the entity that you want to change.</span></span> <span data-ttu-id="4b96a-317">Une façon de gérer cette situation consiste à appeler `AsNoTracking` sur la requête précédente.</span><span class="sxs-lookup"><span data-stu-id="4b96a-317">One way to handle this situation is to call `AsNoTracking` on the earlier query.</span></span>

<span data-ttu-id="4b96a-318">Pour plus d’informations, consultez [vs de suivi. Aucun suivi](https://docs.microsoft.com/ef/core/querying/tracking).</span><span class="sxs-lookup"><span data-stu-id="4b96a-318">For more information, see [Tracking vs. No-Tracking](https://docs.microsoft.com/ef/core/querying/tracking).</span></span>

## <a name="summary"></a><span data-ttu-id="4b96a-319">Résumé</span><span class="sxs-lookup"><span data-stu-id="4b96a-319">Summary</span></span>

<span data-ttu-id="4b96a-320">Vous avez maintenant un ensemble complet de pages qui effectuent des opérations CRUD simples pour les entités de Student.</span><span class="sxs-lookup"><span data-stu-id="4b96a-320">You now have a complete set of pages that perform simple CRUD operations for Student entities.</span></span> <span data-ttu-id="4b96a-321">Dans l’étape suivante du didacticiel, vous allez développer les fonctionnalités de la **Index** page en ajoutant le tri, filtrage et la pagination.</span><span class="sxs-lookup"><span data-stu-id="4b96a-321">In the next tutorial you'll expand the functionality of the **Index** page by adding sorting, filtering, and paging.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="4b96a-322">[Précédent](intro.md)
[Suivant](sort-filter-page.md)</span><span class="sxs-lookup"><span data-stu-id="4b96a-322">[Previous](intro.md)
[Next](sort-filter-page.md)</span></span>  
