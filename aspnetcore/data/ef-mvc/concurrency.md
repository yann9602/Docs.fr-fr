---
title: "Cœur de ASP.NET MVC avec EF Core - d’accès concurrentiel - 8 de 10"
author: tdykstra
description: "Ce didacticiel montre comment gérer les conflits lorsque plusieurs utilisateurs mettre à jour la même entité en même temps."
keywords: "Concurrence d’accès ASP.NET Core, Entity Framework Core,"
ms.author: tdykstra
manager: wpickett
ms.date: 03/15/2017
ms.topic: get-started-article
ms.assetid: 15e79e15-bda5-441d-80c7-8032a2628605
ms.technology: aspnet
ms.prod: asp.net-core
uid: data/ef-mvc/concurrency
ms.openlocfilehash: 9a9ce7eed7ab43a11e1285dec4aa6c0715889dd2
ms.sourcegitcommit: 78d28178345a0eea91556e4cd1adad98b1446db8
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 09/22/2017
---
# <a name="handling-concurrency-conflicts---ef-core-with-aspnet-core-mvc-tutorial-8-of-10"></a><span data-ttu-id="82fac-104">La gestion des conflits d’accès concurrentiel - Core EF avec le didacticiel d’ASP.NET MVC de base (8 sur 10)</span><span class="sxs-lookup"><span data-stu-id="82fac-104">Handling concurrency conflicts - EF Core with ASP.NET Core MVC tutorial (8 of 10)</span></span>

<span data-ttu-id="82fac-105">Par [Tom Dykstra](https://github.com/tdykstra) et [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="82fac-105">By [Tom Dykstra](https://github.com/tdykstra) and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="82fac-106">L’exemple d’application web Contoso University montre comment créer des applications web ASP.NET MVC de base à l’aide d’Entity Framework Core et Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="82fac-106">The Contoso University sample web application demonstrates how to create ASP.NET Core MVC web applications using Entity Framework Core and Visual Studio.</span></span> <span data-ttu-id="82fac-107">Pour plus d’informations sur la série de didacticiels, consultez [le premier didacticiel de la série](intro.md).</span><span class="sxs-lookup"><span data-stu-id="82fac-107">For information about the tutorial series, see [the first tutorial in the series](intro.md).</span></span>

<span data-ttu-id="82fac-108">Dans les didacticiels antérieures, vous avez appris comment mettre à jour des données.</span><span class="sxs-lookup"><span data-stu-id="82fac-108">In earlier tutorials, you learned how to update data.</span></span> <span data-ttu-id="82fac-109">Ce didacticiel montre comment gérer les conflits lorsque plusieurs utilisateurs mettre à jour la même entité en même temps.</span><span class="sxs-lookup"><span data-stu-id="82fac-109">This tutorial shows how to handle conflicts when multiple users update the same entity at the same time.</span></span>

<span data-ttu-id="82fac-110">Vous allez créer des pages web qui utilisent l’entité du service et de gérer les erreurs d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-110">You'll create web pages that work with the Department entity and handle concurrency errors.</span></span> <span data-ttu-id="82fac-111">Les illustrations suivantes montrent les pages modifier et supprimer, y compris des messages qui sont affichent si un conflit de concurrence se produit.</span><span class="sxs-lookup"><span data-stu-id="82fac-111">The following illustrations show the Edit and Delete pages, including some messages that are displayed if a concurrency conflict occurs.</span></span>

![Page de modification du service](concurrency/_static/edit-error.png)

![Page de suppression de service](concurrency/_static/delete-error.png)

## <a name="concurrency-conflicts"></a><span data-ttu-id="82fac-114">Conflits d’accès concurrentiel</span><span class="sxs-lookup"><span data-stu-id="82fac-114">Concurrency conflicts</span></span>

<span data-ttu-id="82fac-115">Un conflit de concurrence se produit lorsqu’un utilisateur affiche les données d’une entité afin de la pour modifier, puis un autre utilisateur met à jour les données de la même entité avant la première modification utilisateur est écrit dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="82fac-115">A concurrency conflict occurs when one user displays an entity's data in order to edit it, and then another user updates the same entity's data before the first user's change is written to the database.</span></span> <span data-ttu-id="82fac-116">Si vous n’activez pas la détection de ces conflits, la personne qui met à jour la base de données remplace dernier les modifications de l’autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="82fac-116">If you don't enable the detection of such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="82fac-117">Dans de nombreuses applications, ce risque est acceptable : s’il existe quelques utilisateurs ou les mises à jour, ou si n’est pas réellement critique si des modifications sont remplacées, le coût de la programmation d’accès concurrentiel peut-être dépasser l’avantage.</span><span class="sxs-lookup"><span data-stu-id="82fac-117">In many applications, this risk is acceptable: if there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.</span></span> <span data-ttu-id="82fac-118">Dans ce cas, vous n’êtes pas obligé de configurer l’application pour gérer les conflits d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-118">In that case, you don't have to configure the application to handle concurrency conflicts.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="82fac-119">L’accès simultané pessimiste (verrouillage)</span><span class="sxs-lookup"><span data-stu-id="82fac-119">Pessimistic concurrency (locking)</span></span>

<span data-ttu-id="82fac-120">Si votre application doit-elle éviter la perte accidentelle de données dans les scénarios d’accès concurrentiel, une manière de procéder consiste à utiliser des verrous de base de données.</span><span class="sxs-lookup"><span data-stu-id="82fac-120">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="82fac-121">Il s’agit d’accès concurrentiel pessimiste.</span><span class="sxs-lookup"><span data-stu-id="82fac-121">This is called pessimistic concurrency.</span></span> <span data-ttu-id="82fac-122">Par exemple, avant de lire une ligne à partir d’une base de données, vous demandez un verrou de lecture seule ou pour l’accès de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="82fac-122">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="82fac-123">Si vous verrouillez une ligne pour l’accès de mise à jour, aucun autre utilisateur n’est autorisés pour le verrouillage de la ligne pour en lecture seule ou mettre à jour de l’accès, car ils obtenez une copie des données sont en cours de modification.</span><span class="sxs-lookup"><span data-stu-id="82fac-123">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="82fac-124">Si vous verrouillez une ligne pour l’accès en lecture seule, d’autres peuvent également le verrouiller pour l’accès en lecture seule, mais pas pour la mise à jour.</span><span class="sxs-lookup"><span data-stu-id="82fac-124">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="82fac-125">Gestion des verrous présente des inconvénients.</span><span class="sxs-lookup"><span data-stu-id="82fac-125">Managing locks has disadvantages.</span></span> <span data-ttu-id="82fac-126">Il peut être complexe au programme.</span><span class="sxs-lookup"><span data-stu-id="82fac-126">It can be complex to program.</span></span> <span data-ttu-id="82fac-127">Il nécessite des ressources de gestion de base de données importantes, et cela peut provoquer des problèmes de performances en tant que le nombre d’utilisateurs d’une application augmente.</span><span class="sxs-lookup"><span data-stu-id="82fac-127">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases.</span></span> <span data-ttu-id="82fac-128">Pour ces raisons, pas tous les systèmes de gestion de base de données prend en charge l’accès simultané pessimiste.</span><span class="sxs-lookup"><span data-stu-id="82fac-128">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="82fac-129">Entity Framework Core ne fournit aucune prise en charge intégrée pour elle et ce didacticiel ne vous montre comment l’implémenter.</span><span class="sxs-lookup"><span data-stu-id="82fac-129">Entity Framework Core provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="82fac-130">Accès concurrentiel optimiste</span><span class="sxs-lookup"><span data-stu-id="82fac-130">Optimistic Concurrency</span></span>

<span data-ttu-id="82fac-131">L’alternative à l’accès concurrentiel pessimiste est l’accès concurrentiel optimiste.</span><span class="sxs-lookup"><span data-stu-id="82fac-131">The alternative to pessimistic concurrency is optimistic concurrency.</span></span> <span data-ttu-id="82fac-132">L’accès concurrentiel optimiste signifie autoriser les conflits d’accès concurrentiel se produire et puis réagir correctement dans le cas.</span><span class="sxs-lookup"><span data-stu-id="82fac-132">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="82fac-133">Par exemple, Jane visite de la page Modifier le service et modifie la quantité d’allocation de réserve pour le service en anglais à partir de $350,000.00 à 0,00 $.</span><span class="sxs-lookup"><span data-stu-id="82fac-133">For example, Jane visits the Department Edit page and changes the Budget amount for the English department from $350,000.00 to $0.00.</span></span>

![La modification de budget à 0](concurrency/_static/change-budget.png)

<span data-ttu-id="82fac-135">Avant de Jane clique sur **enregistrer**, John consulte la même page et modifie le champ Date de début à partir de 1/9/2007, à 1/9/2013.</span><span class="sxs-lookup"><span data-stu-id="82fac-135">Before Jane clicks **Save**, John visits the same page and changes the Start Date field from 9/1/2007 to 9/1/2013.</span></span>

![La modification de la date de début pour 2013](concurrency/_static/change-date.png)

<span data-ttu-id="82fac-137">Jane clique sur **enregistrer** première et voit sa modification lorsque le navigateur revient à la page d’Index.</span><span class="sxs-lookup"><span data-stu-id="82fac-137">Jane clicks **Save** first and sees her change when the browser returns to the Index page.</span></span>

![Allocation de réserve modifiée à zéro](concurrency/_static/budget-zero.png)

<span data-ttu-id="82fac-139">John clique ensuite sur **enregistrer** sur une page d’édition qui affiche toujours un budget de $350,000.00.</span><span class="sxs-lookup"><span data-stu-id="82fac-139">Then John clicks **Save** on an Edit page that still shows a budget of $350,000.00.</span></span> <span data-ttu-id="82fac-140">Que se passe-t-il ensuite est déterminé par la façon dont vous gérez les conflits d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-140">What happens next is determined by how you handle concurrency conflicts.</span></span>

<span data-ttu-id="82fac-141">Certaines de ces options sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="82fac-141">Some of the options include the following:</span></span>

* <span data-ttu-id="82fac-142">Vous pouvez effectuer le suivi des dont un utilisateur a modifié la propriété et mettre à jour uniquement les colonnes correspondantes dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="82fac-142">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span>

     <span data-ttu-id="82fac-143">Dans l’exemple de scénario, aucune donnée n’a été perdue, car des propriétés différentes ont été mis à jour par les deux utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="82fac-143">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="82fac-144">La prochaine fois qu’un utilisateur parcourt le service en anglais, il voit les modifications à la fois de John et Jane : une date de début de 1/9/2013 et un budget de zéro dollars.</span><span class="sxs-lookup"><span data-stu-id="82fac-144">The next time someone browses the English department, they'll see both Jane's and John's changes -- a start date of 9/1/2013 and a budget of zero dollars.</span></span> <span data-ttu-id="82fac-145">Cette méthode de mise à jour peut réduire le nombre de conflits qui peuvent entraîner une perte de données, mais il ne peut pas éviter la perte de données si des modifications concurrentes sont apportées à la même propriété d’une entité.</span><span class="sxs-lookup"><span data-stu-id="82fac-145">This method of updating can reduce the number of conflicts that could result in data loss, but it can't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="82fac-146">Si Entity Framework fonctionne de cette façon dépend de la façon dont vous implémentez votre code de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="82fac-146">Whether the Entity Framework works this way depends on how you implement your update code.</span></span> <span data-ttu-id="82fac-147">Il est souvent pratique dans une application web, car elle peut requérir que vous conservez des grandes quantités d’état afin d’effectuer le suivi de toutes les valeurs de propriété d’origine d’une entité, ainsi que les nouvelles valeurs.</span><span class="sxs-lookup"><span data-stu-id="82fac-147">It's often not practical in a web application, because it can require that you maintain large amounts of state in order to keep track of all original property values for an entity as well as new values.</span></span> <span data-ttu-id="82fac-148">Maintenance de grandes quantités d’état peut affecter les performances de l’application, car il nécessite des ressources serveur ou doit être inclus dans la page web elle-même (par exemple, dans les champs masqués) ou dans un cookie.</span><span class="sxs-lookup"><span data-stu-id="82fac-148">Maintaining large amounts of state can affect application performance because it either requires server resources or must be included in the web page itself (for example, in hidden fields) or in a cookie.</span></span>

* <span data-ttu-id="82fac-149">Vous pouvez laisser les modifications de John écrase les modifications de Jeanne.</span><span class="sxs-lookup"><span data-stu-id="82fac-149">You can let John's change overwrite Jane's change.</span></span>

     <span data-ttu-id="82fac-150">La prochaine fois que quelqu'un accède le service en anglais, il voit le 1/9/2013 et la valeur de $350,000.00 restaurée.</span><span class="sxs-lookup"><span data-stu-id="82fac-150">The next time someone browses the English department, they'll see 9/1/2013 and the restored $350,000.00 value.</span></span> <span data-ttu-id="82fac-151">Cela s’appelle un *Client Wins* ou *dernier dans Wins* scénario.</span><span class="sxs-lookup"><span data-stu-id="82fac-151">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="82fac-152">(Toutes les valeurs à partir du client sont prioritaires sur les nouveautés dans le magasin de données). Comme indiqué dans l’introduction de cette section, si vous ne le faites pas de codage pour la gestion d’accès concurrentiel, cela se produit automatiquement.</span><span class="sxs-lookup"><span data-stu-id="82fac-152">(All values from the client take precedence over what's in the data store.) As noted in the introduction to this section, if you don't do any coding for concurrency handling, this will happen automatically.</span></span>

* <span data-ttu-id="82fac-153">Vous pouvez empêcher la modification de Jean à partir de la mise à jour dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="82fac-153">You can prevent John's change from being updated in the database.</span></span>

     <span data-ttu-id="82fac-154">En règle générale, vous afficher un message d’erreur, lui afficher l’état actuel des données et lui permettre d’appliquer ses modifications s’il veut toujours rendre.</span><span class="sxs-lookup"><span data-stu-id="82fac-154">Typically, you would display an error message, show him the current state of the data, and allow him to reapply his changes if he still wants to make them.</span></span> <span data-ttu-id="82fac-155">Cela s’appelle un *magasin Wins* scénario.</span><span class="sxs-lookup"><span data-stu-id="82fac-155">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="82fac-156">(Les valeurs du magasin de données sont prioritaires sur les valeurs soumis par le client). Vous allez implémenter le scénario de magasin Wins dans ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-156">(The data-store values take precedence over the values submitted by the client.) You'll implement the Store Wins scenario in this tutorial.</span></span> <span data-ttu-id="82fac-157">Cette méthode garantit qu’aucune modification n’est remplacées sans que l’utilisateur est averti que se passe-t-il.</span><span class="sxs-lookup"><span data-stu-id="82fac-157">This method ensures that no changes are overwritten without a user being alerted to what's happening.</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="82fac-158">Détection des conflits d’accès concurrentiel</span><span class="sxs-lookup"><span data-stu-id="82fac-158">Detecting concurrency conflicts</span></span>

<span data-ttu-id="82fac-159">Vous pouvez résoudre les conflits en gérant `DbConcurrencyException` Entity Framework lève les exceptions.</span><span class="sxs-lookup"><span data-stu-id="82fac-159">You can resolve conflicts by handling `DbConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="82fac-160">Pour savoir quand ces exceptions de lever, Entity Framework doit être en mesure de détecter les conflits.</span><span class="sxs-lookup"><span data-stu-id="82fac-160">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="82fac-161">Par conséquent, vous devez configurer la base de données et le modèle de données en conséquence.</span><span class="sxs-lookup"><span data-stu-id="82fac-161">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="82fac-162">Certaines options pour l’activation de la détection de conflit sont les suivantes :</span><span class="sxs-lookup"><span data-stu-id="82fac-162">Some options for enabling conflict detection include the following:</span></span>

* <span data-ttu-id="82fac-163">Dans la table de base de données, incluez une colonne de suivi qui peut être utilisée pour déterminer quand une ligne a été modifiée.</span><span class="sxs-lookup"><span data-stu-id="82fac-163">In the database table, include a tracking column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="82fac-164">Vous pouvez ensuite configurer l’Entity Framework pour inclure cette colonne dont la clause de mise à jour de SQL ou des commandes Delete.</span><span class="sxs-lookup"><span data-stu-id="82fac-164">You can then configure the Entity Framework to include that column in the Where clause of SQL Update or Delete commands.</span></span>

     <span data-ttu-id="82fac-165">Le type de données de la colonne de suivi est généralement `rowversion`.</span><span class="sxs-lookup"><span data-stu-id="82fac-165">The data type of the tracking column is typically `rowversion`.</span></span> <span data-ttu-id="82fac-166">Le `rowversion` valeur est un numéro séquentiel qui est incrémentée chaque fois que la ligne est mise à jour.</span><span class="sxs-lookup"><span data-stu-id="82fac-166">The `rowversion` value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="82fac-167">Dans une commande Update ou Delete, Where clause inclut la valeur d’origine de la colonne de suivi (la version de ligne d’origine).</span><span class="sxs-lookup"><span data-stu-id="82fac-167">In an Update or Delete command, the Where clause includes the original value of the tracking column (the original row version) .</span></span> <span data-ttu-id="82fac-168">Si la ligne mise à jour a été modifiée par un autre utilisateur, la valeur de la `rowversion` colonne est différente de la valeur d’origine, afin que l’instruction Update ou Delete ne peut pas trouver la ligne à mettre à jour en raison de l’emplacement où clause.</span><span class="sxs-lookup"><span data-stu-id="82fac-168">If the row being updated has been changed by another user, the value in the `rowversion` column is different than the original value, so the Update or Delete statement can't find the row to update because of the Where clause.</span></span> <span data-ttu-id="82fac-169">Lors de la recherche d’Entity Framework qu’aucune ligne n’ont été mis à jour par la mise à jour ou la suppression de commandes (autrement dit, lorsque le nombre de lignes affectées est égal à zéro), il qui interprète comme un conflit d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-169">When the Entity Framework finds that no rows have been updated by the Update or Delete command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>

* <span data-ttu-id="82fac-170">Configurer l’Entity Framework pour inclure les valeurs d’origine de chaque colonne dans la table dont la clause de commandes Update et Delete.</span><span class="sxs-lookup"><span data-stu-id="82fac-170">Configure the Entity Framework to include the original values of every column in the table in the Where clause of Update and Delete commands.</span></span>

     <span data-ttu-id="82fac-171">Comme dans la première option, si n’importe où dans la ligne a changé depuis la ligne a été lu tout d’abord, Where clause ne retourne pas une ligne à mettre à jour, lequel Entity Framework interprète comme un conflit d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-171">As in the first option, if anything in the row has changed since the row was first read, the Where clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="82fac-172">Pour les tables de base de données qui ont beaucoup de colonnes, cette approche peut entraîner de très grande taille où les clauses et peut nécessiter que vous avez de grandes quantités d’état.</span><span class="sxs-lookup"><span data-stu-id="82fac-172">For database tables that have many columns, this approach can result in very large Where clauses, and can require that you maintain large amounts of state.</span></span> <span data-ttu-id="82fac-173">Comme indiqué précédemment, en conservant de grandes quantités d’état peut affecter les performances de l’application.</span><span class="sxs-lookup"><span data-stu-id="82fac-173">As noted earlier, maintaining large amounts of state can affect application performance.</span></span> <span data-ttu-id="82fac-174">Par conséquent, cette approche n’est généralement pas recommandée, et il n’est pas la méthode utilisée dans ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-174">Therefore this approach is generally not recommended, and it isn't the method used in this tutorial.</span></span>

     <span data-ttu-id="82fac-175">Si vous ne souhaitez pas implémenter cette approche en matière d’accès concurrentiel, vous devez marquer toutes les propriétés de clé non primaire de l’entité que vous souhaitez effectuer le suivi de la concurrence d’accès en ajoutant le `ConcurrencyCheck` leur attribut.</span><span class="sxs-lookup"><span data-stu-id="82fac-175">If you do want to implement this approach to concurrency, you have to mark all non-primary-key properties in the entity you want to track concurrency for by adding the `ConcurrencyCheck` attribute to them.</span></span> <span data-ttu-id="82fac-176">Cette modification permet à Entity Framework inclure toutes les colonnes dans la clause SQL Where des instructions Update et Delete.</span><span class="sxs-lookup"><span data-stu-id="82fac-176">That change enables the Entity Framework to include all columns in the SQL Where clause of Update and Delete statements.</span></span>

<span data-ttu-id="82fac-177">Dans le reste de ce didacticiel, vous ajouterez un `rowversion` suivi des modifications de propriété à l’entité de service, créer un contrôleur et des vues et de test pour vérifier que tout fonctionne correctement.</span><span class="sxs-lookup"><span data-stu-id="82fac-177">In the remainder of this tutorial you'll add a `rowversion` tracking property to the Department entity, create a controller and views, and test to verify that everything works correctly.</span></span>

## <a name="add-a-tracking-property-to-the-department-entity"></a><span data-ttu-id="82fac-178">Ajouter une propriété de suivi à l’entité du service</span><span class="sxs-lookup"><span data-stu-id="82fac-178">Add a tracking property to the Department entity</span></span>

<span data-ttu-id="82fac-179">Dans *Models/Department.cs*, ajouter une propriété de suivi nommée RowVersion :</span><span class="sxs-lookup"><span data-stu-id="82fac-179">In *Models/Department.cs*, add a tracking property named RowVersion:</span></span>

[!code-csharp[Main](intro/samples/cu/Models/Department.cs?name=snippet_Final&highlight=26,27)]

<span data-ttu-id="82fac-180">Le `Timestamp` attribut spécifie que cette colonne sera incluse dont la clause de mise à jour et supprimer des commandes envoyées à la base de données.</span><span class="sxs-lookup"><span data-stu-id="82fac-180">The `Timestamp` attribute specifies that this column will be included in the Where clause of Update and Delete commands sent to the database.</span></span> <span data-ttu-id="82fac-181">L’attribut est appelé `Timestamp` , car les versions précédentes de SQL Server utilisaient SQL `timestamp` type de données avant l’instruction SQL `rowversion` remplacé.</span><span class="sxs-lookup"><span data-stu-id="82fac-181">The attribute is called `Timestamp` because previous versions of SQL Server used a SQL `timestamp` data type before the SQL `rowversion` replaced it.</span></span> <span data-ttu-id="82fac-182">Le type .NET de `rowversion` est un tableau d’octets.</span><span class="sxs-lookup"><span data-stu-id="82fac-182">The .NET type for `rowversion` is a byte array.</span></span>

<span data-ttu-id="82fac-183">Si vous préférez utiliser l’API fluent, vous pouvez utiliser la `IsConcurrencyToken` (méthode) (dans *Data/SchoolContext.cs*) pour spécifier la propriété de suivi, comme indiqué dans l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="82fac-183">If you prefer to use the fluent API, you can use the `IsConcurrencyToken` method (in *Data/SchoolContext.cs*) to specify the tracking property, as shown in the following example:</span></span>

```csharp
modelBuilder.Entity<Department>()
    .Property(p => p.RowVersion).IsConcurrencyToken();
```

<span data-ttu-id="82fac-184">En ajoutant une propriété, vous avez modifié le modèle de base de données, vous devez effectuer une autre migration.</span><span class="sxs-lookup"><span data-stu-id="82fac-184">By adding a property you changed the database model, so you need to do another migration.</span></span>

<span data-ttu-id="82fac-185">Enregistrer vos modifications et générez le projet, puis entrez les commandes suivantes dans la fenêtre de commande :</span><span class="sxs-lookup"><span data-stu-id="82fac-185">Save your changes and build the project, and then enter the following commands in the command window:</span></span>

```console
dotnet ef migrations add RowVersion
```

```console
dotnet ef database update
```

## <a name="create-a-departments-controller-and-views"></a><span data-ttu-id="82fac-186">Créer un contrôleur de services et des vues</span><span class="sxs-lookup"><span data-stu-id="82fac-186">Create a Departments controller and views</span></span>

<span data-ttu-id="82fac-187">Structurez un contrôleur de services et des vues, comme vous l’avez fait précédemment pour les étudiants, les cours et les formateurs.</span><span class="sxs-lookup"><span data-stu-id="82fac-187">Scaffold a Departments controller and views as you did earlier for Students, Courses, and Instructors.</span></span>

![Service de la vue de structure](concurrency/_static/add-departments-controller.png)

<span data-ttu-id="82fac-189">Dans le *DepartmentsController.cs* , modifiez les quatre occurrences de « FirstMidName » à « FullName » afin que les listes déroulantes d’administrateur service contiendra le nom complet de l’enseignant plutôt que simplement le nom de famille.</span><span class="sxs-lookup"><span data-stu-id="82fac-189">In the *DepartmentsController.cs* file, change all four occurrences of "FirstMidName" to "FullName" so that the department administrator drop-down lists will contain the full name of the instructor rather than just the last name.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?name=snippet_Dropdown)]

## <a name="update-the-departments-index-view"></a><span data-ttu-id="82fac-190">Mise à jour de la vue de l’Index de services</span><span class="sxs-lookup"><span data-stu-id="82fac-190">Update the Departments Index view</span></span>

<span data-ttu-id="82fac-191">Le moteur de génération de modèles automatique a créé une colonne RowVersion dans la vue Index, mais ce champ ne doit pas être affiché.</span><span class="sxs-lookup"><span data-stu-id="82fac-191">The scaffolding engine created a RowVersion column in the Index view, but that field shouldn't be displayed.</span></span>

<span data-ttu-id="82fac-192">Remplacez le code dans *Views/Departments/Index.cshtml* avec le code suivant.</span><span class="sxs-lookup"><span data-stu-id="82fac-192">Replace the code in *Views/Departments/Index.cshtml* with the following code.</span></span>

[!code-html[Main](intro/samples/cu/Views/Departments/Index.cshtml?highlight=4,7,44)]

<span data-ttu-id="82fac-193">Cela modifie l’en-tête pour les « Services », supprime la colonne timestamp et montre le nom complet au lieu du prénom de l’administrateur.</span><span class="sxs-lookup"><span data-stu-id="82fac-193">This changes the heading to "Departments", deletes the RowVersion column, and shows full name instead of first name for the administrator.</span></span>

## <a name="update-the-edit-methods-in-the-departments-controller"></a><span data-ttu-id="82fac-194">Mettre à jour les méthodes de modification dans le contrôleur de services</span><span class="sxs-lookup"><span data-stu-id="82fac-194">Update the Edit methods in the Departments controller</span></span>

<span data-ttu-id="82fac-195">Dans les deux le HttpGet `Edit` (méthode) et le `Details` (méthode), ajouter `AsNoTracking`.</span><span class="sxs-lookup"><span data-stu-id="82fac-195">In both the HttpGet `Edit` method and the `Details` method, add `AsNoTracking`.</span></span> <span data-ttu-id="82fac-196">Dans le HttpGet `Edit` (méthode), ajoutez un chargement hâtif pour l’administrateur.</span><span class="sxs-lookup"><span data-stu-id="82fac-196">In the HttpGet `Edit` method, add eager loading for the Administrator.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?name=snippet_EagerLoading&highlight=2,3)]

<span data-ttu-id="82fac-197">Remplacez le code existant pour le HttpPost `Edit` méthode avec le code suivant :</span><span class="sxs-lookup"><span data-stu-id="82fac-197">Replace the existing code for the HttpPost `Edit` method with the following code:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?name=snippet_EditPost)]

<span data-ttu-id="82fac-198">Le code commence par la tentative de lecture du service de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="82fac-198">The code begins by trying to read the department to be updated.</span></span> <span data-ttu-id="82fac-199">Si le `SingleOrDefaultAsync` méthode retourne la valeur null, le service a été supprimé par un autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="82fac-199">If the `SingleOrDefaultAsync` method returns null, the department was deleted by another user.</span></span> <span data-ttu-id="82fac-200">Dans ce cas, le code utilise les valeurs de formulaire publiées pour créer une entité de service afin que la page de modification peut être actualisée avec un message d’erreur.</span><span class="sxs-lookup"><span data-stu-id="82fac-200">In that case the code uses the posted form values to create a department entity so that the Edit page can be redisplayed with an error message.</span></span> <span data-ttu-id="82fac-201">En guise d’alternative, vous n’avez pas à recréer l’entité du service si vous affichez un message d’erreur sans réaffichage les champs de service.</span><span class="sxs-lookup"><span data-stu-id="82fac-201">As an alternative, you wouldn't have to re-create the department entity if you display only an error message without redisplaying the department fields.</span></span>

<span data-ttu-id="82fac-202">La vue stocke l’original `RowVersion` valeur dans un champ masqué et cette méthode reçoit cette valeur dans la `rowVersion` paramètre.</span><span class="sxs-lookup"><span data-stu-id="82fac-202">The view stores the original `RowVersion` value in a hidden field, and this method receives that value in the `rowVersion` parameter.</span></span> <span data-ttu-id="82fac-203">Avant d’appeler `SaveChanges`, vous devez faire que d’origine `RowVersion` valeur de propriété dans le `OriginalValues` collection pour l’entité.</span><span class="sxs-lookup"><span data-stu-id="82fac-203">Before you call `SaveChanges`, you have to put that original `RowVersion` property value in the `OriginalValues` collection for the entity.</span></span>

```csharp
_context.Entry(departmentToUpdate).Property("RowVersion").OriginalValue = rowVersion;
```

<span data-ttu-id="82fac-204">Lorsque Entity Framework crée une commande de mise à jour de SQL, cette commande inclut une clause WHERE qui recherche une ligne contenant la version d’origine `RowVersion` valeur.</span><span class="sxs-lookup"><span data-stu-id="82fac-204">Then when the Entity Framework creates a SQL UPDATE command, that command will include a WHERE clause that looks for a row that has the original `RowVersion` value.</span></span> <span data-ttu-id="82fac-205">Si aucune ligne n’est affectées par la commande de mise à jour (aucune ligne n’ont d’origine `RowVersion` valeur), Entity Framework lève un `DbUpdateConcurrencyException` exception.</span><span class="sxs-lookup"><span data-stu-id="82fac-205">If no rows are affected by the UPDATE command (no rows have the original `RowVersion` value),  the Entity Framework throws a `DbUpdateConcurrencyException` exception.</span></span>

<span data-ttu-id="82fac-206">Le code dans le bloc catch pour cette exception Obtient l’entité du service affectée qui a les valeurs mises à jour à partir de la `Entries` propriété sur l’objet exception.</span><span class="sxs-lookup"><span data-stu-id="82fac-206">The code in the catch block for that exception gets the affected Department entity that has the updated values from the `Entries` property on the exception object.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?range=164)]

<span data-ttu-id="82fac-207">Le `Entries` collection possède simplement un `EntityEntry` objet.</span><span class="sxs-lookup"><span data-stu-id="82fac-207">The `Entries` collection will have just one `EntityEntry` object.</span></span>  <span data-ttu-id="82fac-208">Vous pouvez utiliser cet objet pour obtenir les nouvelles valeurs entrées par l’utilisateur et les valeurs actuelles de la base de données.</span><span class="sxs-lookup"><span data-stu-id="82fac-208">You can use that object to get the new values entered by the user and the current database values.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?range=165-166)]

<span data-ttu-id="82fac-209">Le code ajoute un message d’erreur personnalisé pour chaque colonne qui a des valeurs de base de données différentes à partir de ce que l’utilisateur entré dans le menu Edition de page (seul un champ est affiché ici par souci de concision).</span><span class="sxs-lookup"><span data-stu-id="82fac-209">The code adds a custom error message for each column that has database values different from what the user entered on the Edit page (only one field is shown here for brevity).</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?range=174-178)]

<span data-ttu-id="82fac-210">Enfin, le code définit les `RowVersion` valeur de la `departmentToUpdate` à la nouvelle valeur récupérée à partir de la base de données.</span><span class="sxs-lookup"><span data-stu-id="82fac-210">Finally, the code sets the `RowVersion` value of the `departmentToUpdate` to the new value retrieved from the database.</span></span> <span data-ttu-id="82fac-211">Cette nouvelle `RowVersion` valeur est stockée dans le champ masqué lorsque la modification de page s’affiche de nouveau et la prochaine fois que l’utilisateur clique sur **enregistrer**, seules les erreurs d’accès concurrentiel qui se produisent dans la mesure où l’actualiser de la page de modification est interceptée.</span><span class="sxs-lookup"><span data-stu-id="82fac-211">This new `RowVersion` value will be stored in the hidden field when the Edit page is redisplayed, and the next time the user clicks **Save**, only concurrency errors that happen since the redisplay of the Edit page will be caught.</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?range=199-200)]

<span data-ttu-id="82fac-212">Le `ModelState.Remove` instruction est requise car `ModelState` a l’ancien `RowVersion` valeur.</span><span class="sxs-lookup"><span data-stu-id="82fac-212">The `ModelState.Remove` statement is required because `ModelState` has the old `RowVersion` value.</span></span> <span data-ttu-id="82fac-213">Dans la vue, le `ModelState` valeur pour un champ est prioritaire sur les valeurs de propriété de modèle lorsque les deux sont présents.</span><span class="sxs-lookup"><span data-stu-id="82fac-213">In the view, the `ModelState` value for a field takes precedence over the model property values when both are present.</span></span>

## <a name="update-the-department-edit-view"></a><span data-ttu-id="82fac-214">Mettre à jour la vue Modifier le service</span><span class="sxs-lookup"><span data-stu-id="82fac-214">Update the Department Edit view</span></span>

<span data-ttu-id="82fac-215">Dans *Views/Departments/Edit.cshtml*, apportez les modifications suivantes :</span><span class="sxs-lookup"><span data-stu-id="82fac-215">In *Views/Departments/Edit.cshtml*, make the following changes:</span></span>

* <span data-ttu-id="82fac-216">Ajouter un champ masqué pour enregistrer le `RowVersion` valeur de propriété, le champ masqué qui suit immédiatement la `DepartmentID` propriété.</span><span class="sxs-lookup"><span data-stu-id="82fac-216">Add a hidden field to save the `RowVersion` property value, immediately following the hidden field for the `DepartmentID` property.</span></span>

* <span data-ttu-id="82fac-217">Ajouter une option « Sélectionner un administrateur » à la liste déroulante.</span><span class="sxs-lookup"><span data-stu-id="82fac-217">Add a "Select Administrator" option to the drop-down list.</span></span>

[!code-html[Main](intro/samples/cu/Views/Departments/Edit.cshtml?highlight=16,34-36)]

## <a name="test-concurrency-conflicts-in-the-edit-page"></a><span data-ttu-id="82fac-218">Tester les conflits d’accès concurrentiel dans la page de modification</span><span class="sxs-lookup"><span data-stu-id="82fac-218">Test concurrency conflicts in the Edit page</span></span>

<span data-ttu-id="82fac-219">Exécutez l’application et accédez à la page d’Index de services.</span><span class="sxs-lookup"><span data-stu-id="82fac-219">Run the app and go to the Departments Index page.</span></span> <span data-ttu-id="82fac-220">Avec le bouton droit le **modifier** lien hypertexte pour le service en anglais, puis sélectionnez **ouvrir dans un nouvel onglet**, puis cliquez sur le **modifier** lien hypertexte pour le service en anglais.</span><span class="sxs-lookup"><span data-stu-id="82fac-220">Right-click the **Edit** hyperlink for the English department and select **Open in new tab**, then click the **Edit** hyperlink for the English department.</span></span> <span data-ttu-id="82fac-221">Les onglets de deux navigateur affichent désormais les mêmes informations.</span><span class="sxs-lookup"><span data-stu-id="82fac-221">The two browser tabs now display the same information.</span></span>

<span data-ttu-id="82fac-222">Modifier un champ dans le premier onglet de navigateur, cliquez sur **enregistrer**.</span><span class="sxs-lookup"><span data-stu-id="82fac-222">Change a field in the first browser tab and click **Save**.</span></span>

![Édition de service page 1 après modification](concurrency/_static/edit-after-change-1.png)

<span data-ttu-id="82fac-224">Le navigateur affiche la page d’Index de la valeur modifiée.</span><span class="sxs-lookup"><span data-stu-id="82fac-224">The browser shows the Index page with the changed value.</span></span>

<span data-ttu-id="82fac-225">Modifier un champ dans le deuxième onglet du navigateur.</span><span class="sxs-lookup"><span data-stu-id="82fac-225">Change a field in the second browser tab.</span></span>

![Modification du service page 2 après la modification](concurrency/_static/edit-after-change-2.png)

<span data-ttu-id="82fac-227">Cliquez sur **Enregistrer**.</span><span class="sxs-lookup"><span data-stu-id="82fac-227">Click **Save**.</span></span> <span data-ttu-id="82fac-228">Vous voyez un message d’erreur :</span><span class="sxs-lookup"><span data-stu-id="82fac-228">You see an error message:</span></span>

![Message d’erreur service modifier page](concurrency/_static/edit-error.png)

<span data-ttu-id="82fac-230">Cliquez sur **enregistrer** à nouveau.</span><span class="sxs-lookup"><span data-stu-id="82fac-230">Click **Save** again.</span></span> <span data-ttu-id="82fac-231">La valeur que vous avez entré dans le deuxième onglet navigateur est enregistrée.</span><span class="sxs-lookup"><span data-stu-id="82fac-231">The value you entered in the second browser tab is saved.</span></span> <span data-ttu-id="82fac-232">Vous voyez les valeurs enregistrées lorsque la page d’Index s’affiche.</span><span class="sxs-lookup"><span data-stu-id="82fac-232">You see the saved values when the Index page appears.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="82fac-233">Mise à jour de la page de suppression</span><span class="sxs-lookup"><span data-stu-id="82fac-233">Update the Delete page</span></span>

<span data-ttu-id="82fac-234">Pour la page de suppression, Entity Framework détecte les conflits d’accès concurrentiel causés par quelqu'un d’autre modification du service d’une manière similaire.</span><span class="sxs-lookup"><span data-stu-id="82fac-234">For the Delete page, the Entity Framework detects concurrency conflicts caused by someone else editing the department in a similar manner.</span></span> <span data-ttu-id="82fac-235">Lorsque le HttpGet `Delete` méthode affiche la vue de confirmation, la vue inclut la version d’origine `RowVersion` valeur dans un champ masqué.</span><span class="sxs-lookup"><span data-stu-id="82fac-235">When the HttpGet `Delete` method displays the confirmation view, the view includes the original `RowVersion` value in a hidden field.</span></span> <span data-ttu-id="82fac-236">Que valeur est ensuite disponible pour le HttpPost `Delete` méthode qui est appelée lorsque l’utilisateur confirme la suppression.</span><span class="sxs-lookup"><span data-stu-id="82fac-236">That value is then available to the HttpPost `Delete` method that's called when the user confirms the deletion.</span></span> <span data-ttu-id="82fac-237">Lorsque Entity Framework crée la commande SQL DELETE, il inclut une clause WHERE avec la version d’origine `RowVersion` valeur.</span><span class="sxs-lookup"><span data-stu-id="82fac-237">When the Entity Framework creates the SQL DELETE command, it includes a WHERE clause with the original `RowVersion` value.</span></span> <span data-ttu-id="82fac-238">Si les résultats de la commande dans des lignes nulles affectés (c'est-à-dire la ligne a été modifiée après l’affichage de la page de confirmation de suppression), une exception d’accès concurrentiel est levée et le HttpGet `Delete` méthode est appelée avec un indicateur d’erreur sur « True » pour réafficher le page de confirmation avec un message d’erreur.</span><span class="sxs-lookup"><span data-stu-id="82fac-238">If the command results in zero rows affected (meaning the row was changed after the Delete confirmation page was displayed), a concurrency exception is thrown, and the HttpGet `Delete` method is called with an error flag set to true in order to redisplay the confirmation page with an error message.</span></span> <span data-ttu-id="82fac-239">Il est également possible qu’aucune ligne ont été affectés, car la ligne a été supprimée par un autre utilisateur, afin que dans ce cas, aucun message d’erreur n’est affiché.</span><span class="sxs-lookup"><span data-stu-id="82fac-239">It's also possible that zero rows were affected because the row was deleted by another user, so in that case no error message is displayed.</span></span>

### <a name="update-the-delete-methods-in-the-departments-controller"></a><span data-ttu-id="82fac-240">Mettre à jour les méthodes de suppression dans le contrôleur de services</span><span class="sxs-lookup"><span data-stu-id="82fac-240">Update the Delete methods in the Departments controller</span></span>

<span data-ttu-id="82fac-241">Dans *DepartmentsController.cs*, remplacez le HttpGet `Delete` méthode avec le code suivant :</span><span class="sxs-lookup"><span data-stu-id="82fac-241">In *DepartmentsController.cs*, replace the HttpGet `Delete` method with the following code:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?name=snippet_DeleteGet&highlight=1,10,14-17,21-29)]

<span data-ttu-id="82fac-242">La méthode accepte un paramètre facultatif qui indique si la page est en cours affiche de nouveau après une erreur d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-242">The method accepts an optional parameter that indicates whether the page is being redisplayed after a concurrency error.</span></span> <span data-ttu-id="82fac-243">Si cet indicateur a la valeur true et que le service spécifié n’est plus existe, il a été supprimé par un autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="82fac-243">If this flag is true and the department specified no longer exists, it was deleted by another user.</span></span> <span data-ttu-id="82fac-244">Dans ce cas, le code redirige vers la page d’Index.</span><span class="sxs-lookup"><span data-stu-id="82fac-244">In that case, the code redirects to the Index page.</span></span>  <span data-ttu-id="82fac-245">Si cet indicateur a la valeur true et que le service n’existe pas, il a été modifié par un autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="82fac-245">If this flag is true and the Department does exist, it was changed by another user.</span></span> <span data-ttu-id="82fac-246">Dans ce cas, le code envoie un message d’erreur à la vue à l’aide de `ViewData`.</span><span class="sxs-lookup"><span data-stu-id="82fac-246">In that case, the code sends an error message to the view using `ViewData`.</span></span>  

<span data-ttu-id="82fac-247">Remplacez le code dans le HttpPost `Delete` (méthode) (nommé `DeleteConfirmed`) avec le code suivant :</span><span class="sxs-lookup"><span data-stu-id="82fac-247">Replace the code in the HttpPost `Delete` method (named `DeleteConfirmed`) with the following code:</span></span>

[!code-csharp[Main](intro/samples/cu/Controllers/DepartmentsController.cs?name=snippet_DeletePost&highlight=1,3,5-8,11-18)]

<span data-ttu-id="82fac-248">Dans le code de modèle généré automatiquement qui vient d’être remplacé, cette méthode acceptées uniquement un ID d’enregistrement :</span><span class="sxs-lookup"><span data-stu-id="82fac-248">In the scaffolded code that you just replaced, this method accepted only a record ID:</span></span>


```csharp
public async Task<IActionResult> DeleteConfirmed(int id)
```

<span data-ttu-id="82fac-249">Vous avez modifié ce paramètre dans une instance d’entité de service créée par le classeur de modèles.</span><span class="sxs-lookup"><span data-stu-id="82fac-249">You've changed this parameter to a Department entity instance created by the model binder.</span></span> <span data-ttu-id="82fac-250">Cela donne accès EF à la valeur de propriété RowVersion en plus de la clé d’enregistrement.</span><span class="sxs-lookup"><span data-stu-id="82fac-250">This gives EF access to the RowVersion property value in addition to the record key.</span></span>

```csharp
public async Task<IActionResult> Delete(Department department)
```

<span data-ttu-id="82fac-251">Vous avez également modifié le nom de la méthode d’action à partir de `DeleteConfirmed` à `Delete`.</span><span class="sxs-lookup"><span data-stu-id="82fac-251">You have also changed the action method name from `DeleteConfirmed` to `Delete`.</span></span> <span data-ttu-id="82fac-252">Le code de modèle généré automatiquement utilisé le nom `DeleteConfirmed` pour permettre à la méthode HttpPost une signature unique.</span><span class="sxs-lookup"><span data-stu-id="82fac-252">The scaffolded code used the name `DeleteConfirmed` to give the HttpPost method a unique signature.</span></span> <span data-ttu-id="82fac-253">(Le CLR a besoin des méthodes surchargées pour avoir des paramètres de l’autre méthode.) Maintenant que les signatures sont uniques, vous pouvez coller avec la convention MVC et utiliser le même nom pour les méthodes de suppression HttpPost et HttpGet.</span><span class="sxs-lookup"><span data-stu-id="82fac-253">(The CLR requires overloaded methods to have different method parameters.) Now that the signatures are unique, you can stick with the MVC convention and use the same name for the HttpPost and HttpGet delete methods.</span></span>

<span data-ttu-id="82fac-254">Si le service a déjà été supprimé, le `AnyAsync` méthode retourne la valeur false et l’application simplement revient à la méthode de l’Index.</span><span class="sxs-lookup"><span data-stu-id="82fac-254">If the department is already deleted, the `AnyAsync` method returns false and the application just goes back to the Index method.</span></span>

<span data-ttu-id="82fac-255">Si une erreur d’accès concurrentiel est interceptée, le code affiche la page de confirmation de suppression de nouveau et fournit un indicateur qui indique qu’il doit afficher un message d’erreur d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-255">If a concurrency error is caught, the code redisplays the Delete confirmation page and provides a flag that indicates it should display a concurrency error message.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="82fac-256">Mettre à jour la vue Delete</span><span class="sxs-lookup"><span data-stu-id="82fac-256">Update the Delete view</span></span>

<span data-ttu-id="82fac-257">Dans *Views/Departments/Delete.cshtml*, remplacez le code de modèle généré automatiquement par le code suivant qui ajoute un champ de message d’erreur et les champs masqués pour les propriétés de DepartmentID et RowVersion.</span><span class="sxs-lookup"><span data-stu-id="82fac-257">In *Views/Departments/Delete.cshtml*, replace the scaffolded code with the following code that adds an error message field and hidden fields for the DepartmentID and RowVersion properties.</span></span> <span data-ttu-id="82fac-258">Les modifications sont mises en surbrillance.</span><span class="sxs-lookup"><span data-stu-id="82fac-258">The changes are highlighted.</span></span>

[!code-html[Main](intro/samples/cu/Views/Departments/Delete.cshtml?highlight=9,38,44,45,48)]

<span data-ttu-id="82fac-259">Il apporte les modifications suivantes :</span><span class="sxs-lookup"><span data-stu-id="82fac-259">This makes the following changes:</span></span>

* <span data-ttu-id="82fac-260">Ajoute un message d’erreur entre la `h2` et `h3` des en-têtes.</span><span class="sxs-lookup"><span data-stu-id="82fac-260">Adds an error message between the `h2` and `h3` headings.</span></span>

* <span data-ttu-id="82fac-261">Remplace FirstMidName FullName dans le **administrateur** champ.</span><span class="sxs-lookup"><span data-stu-id="82fac-261">Replaces FirstMidName with FullName in the **Administrator** field.</span></span>

* <span data-ttu-id="82fac-262">Supprime le champ RowVersion.</span><span class="sxs-lookup"><span data-stu-id="82fac-262">Removes the RowVersion field.</span></span>

* <span data-ttu-id="82fac-263">Ajoute un champ masqué pour le `RowVersion` propriété.</span><span class="sxs-lookup"><span data-stu-id="82fac-263">Adds a hidden field for the `RowVersion` property.</span></span>

<span data-ttu-id="82fac-264">Exécutez l’application et accédez à la page d’Index de services.</span><span class="sxs-lookup"><span data-stu-id="82fac-264">Run the app and go to the Departments Index page.</span></span> <span data-ttu-id="82fac-265">Avec le bouton droit le **supprimer** lien hypertexte pour le service en anglais, puis sélectionnez **ouvrir dans un nouvel onglet**, puis, dans le premier onglet, cliquez sur le **modifier** lien hypertexte pour le service en anglais.</span><span class="sxs-lookup"><span data-stu-id="82fac-265">Right-click the **Delete** hyperlink for the English department and select **Open in new tab**, then in the first tab click the **Edit** hyperlink for the English department.</span></span>

<span data-ttu-id="82fac-266">Dans la première fenêtre, modifiez l’une des valeurs, puis cliquez sur **enregistrer**:</span><span class="sxs-lookup"><span data-stu-id="82fac-266">In the first window, change one of the values, and click **Save**:</span></span>

![Page de modification du service après modification avant la suppression](concurrency/_static/edit-after-change-for-delete.png)

<span data-ttu-id="82fac-268">Dans le deuxième onglet, cliquez sur **supprimer**.</span><span class="sxs-lookup"><span data-stu-id="82fac-268">In the second tab, click **Delete**.</span></span> <span data-ttu-id="82fac-269">Vous voyez le message d’erreur d’accès concurrentiel et les valeurs de service sont actualisés avec ce qui est actuellement dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="82fac-269">You see the concurrency error message, and the Department values are refreshed with what's currently in the database.</span></span>

![Page de confirmation de suppression de service avec erreur d’accès concurrentiel](concurrency/_static/delete-error.png)

<span data-ttu-id="82fac-271">Si vous cliquez sur **supprimer** là encore, vous êtes redirigé vers la page d’Index, ce qui indique que le service a été supprimé.</span><span class="sxs-lookup"><span data-stu-id="82fac-271">If you click **Delete** again, you're redirected to the Index page, which shows that the department has been deleted.</span></span>

## <a name="update-details-and-create-views"></a><span data-ttu-id="82fac-272">Mettre à jour les détails et de créer des vues</span><span class="sxs-lookup"><span data-stu-id="82fac-272">Update Details and Create views</span></span>

<span data-ttu-id="82fac-273">Vous pouvez éventuellement nettoyer le code de modèle généré automatiquement dans les détails et créer des vues.</span><span class="sxs-lookup"><span data-stu-id="82fac-273">You can optionally clean up scaffolded code in the Details and Create views.</span></span>

<span data-ttu-id="82fac-274">Remplacez le code dans *Views/Departments/Details.cshtml* à supprimer la colonne timestamp, puis affichez le nom complet de l’administrateur.</span><span class="sxs-lookup"><span data-stu-id="82fac-274">Replace the code in *Views/Departments/Details.cshtml* to delete the RowVersion column and show the full name of the Administrator.</span></span>

[!code-html[Main](intro/samples/cu/Views/Departments/Details.cshtml?highlight=35)]

<span data-ttu-id="82fac-275">Remplacez le code dans *Views/Departments/Create.cshtml* pour ajouter une option de sélection à la liste déroulante.</span><span class="sxs-lookup"><span data-stu-id="82fac-275">Replace the code in *Views/Departments/Create.cshtml* to add a Select option to the drop-down list.</span></span>

[!code-html[Main](intro/samples/cu/Views/Departments/Create.cshtml?highlight=32-34)]

## <a name="summary"></a><span data-ttu-id="82fac-276">Résumé</span><span class="sxs-lookup"><span data-stu-id="82fac-276">Summary</span></span>

<span data-ttu-id="82fac-277">Cette étape termine l’introduction à la gestion des conflits d’accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="82fac-277">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="82fac-278">Pour plus d’informations sur la façon de gérer l’accès concurrentiel dans EF Core, consultez [conflits d’accès concurrentiel](https://docs.microsoft.com/ef/core/saving/concurrency).</span><span class="sxs-lookup"><span data-stu-id="82fac-278">For more information about how to handle concurrency in EF Core, see [Concurrency conflicts](https://docs.microsoft.com/ef/core/saving/concurrency).</span></span> <span data-ttu-id="82fac-279">Le didacticiel suivant montre comment implémenter l’héritage table par hiérarchie pour les entités Instructor et Student.</span><span class="sxs-lookup"><span data-stu-id="82fac-279">The next tutorial shows how to implement table-per-hierarchy inheritance for the Instructor and Student entities.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="82fac-280">[Précédent](update-related-data.md)
[Suivant](inheritance.md)</span><span class="sxs-lookup"><span data-stu-id="82fac-280">[Previous](update-related-data.md)
[Next](inheritance.md)</span></span>  
